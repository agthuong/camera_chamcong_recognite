{% extends 'recognition/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Lên lịch nhận diện tự động{% endblock %}

{% block extra_head %}
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@x.x.x/dist/select2-bootstrap4.min.css" rel="stylesheet" />
    <!-- Toastify CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <!-- DateTimePicker CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.39.0/css/tempusdominus-bootstrap-4.min.css">
    <style>
        .schedule-card {
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }
        .schedule-card:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        .schedule-status {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .status-active {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        .status-paused {
            background-color: #fff3cd;
            color: #664d03;
        }
        .status-completed {
            background-color: #cff4fc;
            color: #055160;
        }
        .schedule-list {
            margin-top: 2rem;
        }
        .form-card {
            margin-bottom: 2rem;
        }
        .form-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .form-toggle-btn {
            cursor: pointer;
        }
        .log-card {
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            padding: 0.5rem 0;
            border-bottom: 1px solid #e9ecef;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .checkboxes-container {
            display: flex;
            flex-wrap: wrap;
        }
        .checkboxes-container div {
            flex: 0 0 25%;
            margin-bottom: 0.5rem;
        }
        @media (max-width: 768px) {
            .checkboxes-container div {
                flex: 0 0 50%;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4 text-center">Lên lịch nhận diện tự động</h2>
    
    <!-- Thông báo -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Card giới thiệu -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Tính năng lên lịch tự động</h5>
            <p class="card-text">Tính năng này cho phép bạn thiết lập lịch trình nhận diện tự động cho các camera, mà không cần hiển thị video lên web. Hệ thống sẽ tự động thực hiện việc nhận diện và lưu kết quả vào cơ sở dữ liệu theo các khung giờ bạn thiết lập.</p>
            <div class="alert alert-info mb-0">
                <i class="fas fa-info-circle mr-2"></i> Lưu ý: Máy chủ cần được chạy liên tục để tính năng này hoạt động. Nếu máy chủ bị tắt, các lịch trình sẽ không được thực hiện cho đến khi máy chủ được khởi động lại.
            </div>
        </div>
    </div>

    <!-- Hướng dẫn chạy scheduler -->
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">Hướng dẫn kích hoạt scheduler</h5>
        </div>
        <div class="card-body">
            <p>Để kích hoạt tính năng lên lịch tự động, bạn cần chạy scheduler trong một tiến trình riêng biệt. Mở terminal và thực hiện các bước sau:</p>
            
            <div class="alert alert-dark p-3">
                <pre class="mb-0"><code># Activate your virtual environment (if using one)
# Example: source venv/bin/activate

# Navigate to your project directory
# Example: cd /path/to/your/project

# Run the scheduler
python recognition/scheduled_recognition_runner.py</code></pre>
            </div>
            
            <p class="mt-3">Để chạy scheduler trong nền (background):</p>
            
            <div class="alert alert-dark p-3">
                <pre class="mb-0"><code># Trên Linux/Mac
nohup python recognition/scheduled_recognition_runner.py > scheduler.log 2>&1 &

# Trên Windows (sử dụng PowerShell)
Start-Process -NoNewWindow python -ArgumentList "recognition/scheduled_recognition_runner.py"</code></pre>
            </div>
            
            <div class="alert alert-warning mt-3">
                <i class="fas fa-exclamation-triangle mr-2"></i> Scheduler phải được chạy cùng lúc với máy chủ Django để lịch trình nhận diện hoạt động.
            </div>
        </div>
    </div>

    <!-- Form thêm/sửa lịch trình -->
    <div class="card form-card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">{{ form.instance.id|yesno:"Chỉnh sửa,Thêm mới" }} lịch trình</h5>
            <button type="button" class="btn btn-light btn-sm form-toggle-btn" id="form-toggle-btn">
                <i class="fas fa-chevron-up"></i>
            </button>
        </div>
        <div class="card-body" id="form-body">
            <form method="POST" id="schedule-form">
                {% csrf_token %}
                {% if form.instance.id %}
                    <input type="hidden" name="schedule_id" value="{{ form.instance.id }}">
                {% endif %}
                
                <div class="row">
                    <div class="col-md-6">
                        {{ form.name|as_crispy_field }}
                    </div>
                    <div class="col-md-6">
                        {{ form.camera|as_crispy_field }}
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        {{ form.start_time|as_crispy_field }}
                    </div>
                    <div class="col-md-6">
                        {{ form.end_time|as_crispy_field }}
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        {{ form.interval_minutes|as_crispy_field }}
                    </div>
                    <div class="col-md-6">
                        {{ form.status|as_crispy_field }}
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="{{ form.active_days.id_for_label }}">{{ form.active_days.label }}</label>
                    <div class="checkboxes-container">
                        {% for checkbox in form.active_days %}
                            <div class="form-check">
                                {{ checkbox }}
                            </div>
                        {% endfor %}
                    </div>
                    {% if form.active_days.errors %}
                        <div class="invalid-feedback d-block">{{ form.active_days.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group text-center mt-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save mr-2"></i>{{ form.instance.id|yesno:"Cập nhật,Tạo mới" }}
                    </button>
                    {% if form.instance.id %}
                        <a href="{% url 'scheduled-recognition' %}" class="btn btn-secondary ml-2">
                            <i class="fas fa-plus mr-2"></i>Tạo mới
                        </a>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <!-- Danh sách lịch trình -->
    <div class="schedule-list">
        <h4 class="mb-3">Lịch trình đã thiết lập</h4>
        
        {% if schedules %}
            <div class="row">
                {% for schedule in schedules %}
                    <div class="col-lg-6">
                        <div class="card schedule-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">{{ schedule.name }}</h5>
                                <span class="schedule-status status-{{ schedule.status }}">
                                    {{ schedule.get_status_display }}
                                </span>
                            </div>
                            <div class="card-body">
                                <p><strong>Camera:</strong> {{ schedule.camera.name }}</p>
                                <p><strong>Thời gian:</strong> {{ schedule.start_time|time:"H:i" }} - {{ schedule.end_time|time:"H:i" }}</p>
                                <p><strong>Khoảng cách:</strong> {{ schedule.get_interval_minutes_display }}</p>
                                <p><strong>Ngày hoạt động:</strong> 
                                    {% with days=schedule.active_days.split|make_list %}
                                        {% if "1" in days %}Thứ 2, {% endif %}
                                        {% if "2" in days %}Thứ 3, {% endif %}
                                        {% if "3" in days %}Thứ 4, {% endif %}
                                        {% if "4" in days %}Thứ 5, {% endif %}
                                        {% if "5" in days %}Thứ 6, {% endif %}
                                        {% if "6" in days %}Thứ 7, {% endif %}
                                        {% if "7" in days %}CN{% endif %}
                                    {% endwith %}
                                </p>
                                {% if schedule.last_run %}
                                    <p><strong>Lần chạy cuối:</strong> {{ schedule.last_run|date:"d/m/Y H:i:s" }}</p>
                                {% endif %}
                                {% if schedule.next_run %}
                                    <p><strong>Lần chạy tiếp theo:</strong> {{ schedule.next_run|date:"d/m/Y H:i:s" }}</p>
                                {% endif %}
                                <div class="mt-3 text-right">
                                    <a href="{% url 'edit-schedule' schedule.id %}" class="btn btn-sm btn-secondary">
                                        <i class="fas fa-edit"></i> Sửa
                                    </a>
                                    <button class="btn btn-sm btn-{{ schedule.status|yesno:'warning,success' }} toggle-status-btn" 
                                            data-id="{{ schedule.id }}" 
                                            data-status="{{ schedule.status }}"
                                            data-csrf="{{ csrf_token }}">
                                        <i class="fas fa-{{ schedule.status|yesno:'pause,play' }}"></i> 
                                        {{ schedule.status|yesno:'Tạm dừng,Kích hoạt' }}
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-schedule-btn" 
                                            data-id="{{ schedule.id }}"
                                            data-name="{{ schedule.name }}"
                                            data-csrf="{{ csrf_token }}">
                                        <i class="fas fa-trash"></i> Xóa
                                    </button>
                                    <button class="btn btn-sm btn-info run-now-btn" 
                                            data-id="{{ schedule.id }}"
                                            data-name="{{ schedule.name }}">
                                        <i class="fas fa-play-circle"></i> Chạy ngay
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle mr-2"></i> Chưa có lịch trình nào được thiết lập. Vui lòng tạo lịch trình mới.
            </div>
        {% endif %}
    </div>

    <!-- Lịch sử nhận diện gần đây -->
    <div class="card mt-4 mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">Lịch sử nhận diện tự động gần đây</h5>
        </div>
        <div class="card-body log-card">
            {% if logs %}
                {% for log in logs %}
                    <div class="log-entry">
                        <div class="d-flex justify-content-between">
                            <span><strong>{{ log.schedule.name }}</strong> ({{ log.schedule.camera.name }})</span>
                            <span class="text-muted">{{ log.timestamp|date:"d/m/Y H:i:s" }}</span>
                        </div>
                        <div>
                            {% if log.success %}
                                <span class="text-success"><i class="fas fa-check-circle"></i> {{ log.message }}</span>
                            {% else %}
                                <span class="text-danger"><i class="fas fa-exclamation-circle"></i> {{ log.message }}</span>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p class="text-muted text-center">Chưa có lịch sử nhận diện tự động.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extrajs %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script>
    $(document).ready(function() {
        // Khởi tạo Select2
        $('.select2').select2({
            theme: 'bootstrap4',
            width: '100%'
        });
        
        // Toggle form
        $('#form-toggle-btn').click(function() {
            $('#form-body').slideToggle();
            $(this).find('i').toggleClass('fa-chevron-up fa-chevron-down');
        });
        
        // Xử lý toggle trạng thái
        $('.toggle-status-btn').click(function() {
            const scheduleId = $(this).data('id');
            const currentStatus = $(this).data('status');
            const csrfToken = $(this).data('csrf');
            const newStatus = currentStatus === 'active' ? 'paused' : 'active';
            const actionText = currentStatus === 'active' ? 'tạm dừng' : 'kích hoạt';
            
            Swal.fire({
                title: `Xác nhận ${actionText}?`,
                text: `Bạn có chắc muốn ${actionText} lịch trình này?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Đồng ý',
                cancelButtonText: 'Hủy bỏ'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Gửi AJAX request để thay đổi trạng thái
                    $.ajax({
                        url: "{% url 'toggle-schedule-status' %}",
                        type: "POST",
                        data: {
                            'schedule_id': scheduleId,
                            'status': newStatus,
                            'csrfmiddlewaretoken': csrfToken
                        },
                        success: function(response) {
                            if (response.status === 'success') {
                                Toastify({
                                    text: `Đã ${actionText} lịch trình thành công!`,
                                    duration: 3000,
                                    gravity: "top",
                                    position: "right",
                                    backgroundColor: "#28a745"
                                }).showToast();
                                
                                // Reload để cập nhật giao diện
                                setTimeout(function() {
                                    location.reload();
                                }, 1000);
                            } else {
                                Swal.fire('Lỗi!', response.message, 'error');
                            }
                        },
                        error: function() {
                            Swal.fire('Lỗi!', 'Đã xảy ra lỗi khi xử lý yêu cầu.', 'error');
                        }
                    });
                }
            });
        });
        
        // Xử lý xóa lịch trình
        $('.delete-schedule-btn').click(function() {
            const scheduleId = $(this).data('id');
            const scheduleName = $(this).data('name');
            const csrfToken = $(this).data('csrf');
            
            Swal.fire({
                title: 'Xác nhận xóa?',
                html: `Bạn có chắc muốn xóa lịch trình <strong>${scheduleName}</strong>?<br>Hành động này không thể hoàn tác.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy bỏ'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Gửi AJAX request để xóa lịch trình
                    $.ajax({
                        url: "{% url 'delete-schedule' %}",
                        type: "POST",
                        data: {
                            'schedule_id': scheduleId,
                            'csrfmiddlewaretoken': csrfToken
                        },
                        success: function(response) {
                            if (response.status === 'success') {
                                Toastify({
                                    text: "Đã xóa lịch trình thành công!",
                                    duration: 3000,
                                    gravity: "top",
                                    position: "right",
                                    backgroundColor: "#28a745"
                                }).showToast();
                                
                                // Reload để cập nhật giao diện
                                setTimeout(function() {
                                    location.reload();
                                }, 1000);
                            } else {
                                Swal.fire('Lỗi!', response.message, 'error');
                            }
                        },
                        error: function() {
                            Swal.fire('Lỗi!', 'Đã xảy ra lỗi khi xử lý yêu cầu.', 'error');
                        }
                    });
                }
            });
        });

        // Xử lý nút Chạy ngay lập tức
        $('.run-now-btn').click(function() {
            const scheduleId = $(this).data('id');
            const scheduleName = $(this).data('name');
            const button = $(this);
            
            Swal.fire({
                title: 'Xác nhận chạy ngay?',
                html: `Bạn có chắc muốn chạy lịch trình <strong>${scheduleName}</strong> ngay bây giờ?<br>Quá trình này có thể mất vài giây.`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Chạy ngay',
                cancelButtonText: 'Hủy bỏ'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Hiển thị loading
                    Swal.fire({
                        title: 'Đang thực hiện...',
                        html: 'Vui lòng chờ trong khi hệ thống thực hiện nhận diện.',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    // Vô hiệu hóa nút
                    button.prop('disabled', true);
                    
                    // Gửi AJAX request
                    $.ajax({
                        url: `/test-schedule/${scheduleId}/`,
                        type: 'GET',
                        success: function(response) {
                            Swal.close();
                            
                            if (response.status === 'success') {
                                Swal.fire({
                                    title: 'Thành công!',
                                    html: response.message,
                                    icon: 'success'
                                }).then(() => {
                                    // Reload để cập nhật giao diện
                                    location.reload();
                                });
                            } else {
                                Swal.fire({
                                    title: 'Lỗi!',
                                    html: response.message || 'Có lỗi xảy ra khi thực hiện nhận diện.',
                                    icon: 'error'
                                });
                            }
                        },
                        error: function(xhr, status, error) {
                            Swal.close();
                            
                            let errorMessage = 'Có lỗi xảy ra khi thực hiện nhận diện.';
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMessage = xhr.responseJSON.message;
                            }
                            
                            Swal.fire({
                                title: 'Lỗi!',
                                html: errorMessage,
                                icon: 'error'
                            });
                        },
                        complete: function() {
                            // Kích hoạt lại nút
                            button.prop('disabled', false);
                        }
                    });
                }
            });
        });
    });
</script>
{% endblock %} 