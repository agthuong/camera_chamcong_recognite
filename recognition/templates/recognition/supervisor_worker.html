{% extends 'recognition/base.html' %}
{% load static %}

{% block title %}Quản lý Supervisor và Worker{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-center mb-0">Danh sách Supervisor và Worker</h1>
        <button class="btn btn-warning" id="sync-firebase-btn" title="Đồng bộ danh sách Supervisor-Worker lên Firebase">
            <i class="fas fa-sync-alt"></i> Đồng bộ lên Firebase
        </button>
    </div>
    
    <!-- Thêm CSS inline để khắc phục vấn đề hiển thị -->
    <style>
        /* Đảm bảo các card có chiều cao đồng đều */
        .supervisor-card {
            height: 100%;
            margin-bottom: 20px;
        }
        
        /* Đảm bảo các card xuống hàng đúng sau mỗi 3 card trên màn hình lớn */
        @media (min-width: 992px) {
            .clearfix-lg {
                clear: both;
                display: block;
            }
        }
        
        /* Đảm bảo các card xuống hàng đúng sau mỗi 2 card trên màn hình trung bình */
        @media (min-width: 768px) and (max-width: 991.98px) {
            .clearfix-md {
                clear: both;
                display: block;
            }
        }
        
        /* Fix một số vấn đề với Bootstrap 4 */
        .me-2 {
            margin-right: 0.5rem !important;
        }
        
        .text-end {
            text-align: right !important;
        }

        /* Cải thiện giao diện card supervisor */
        .supervisor-card .card-header {
            padding: 0.75rem 1rem;
        }
        
        .supervisor-card .supervisor-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0;
        }

        .supervisor-info {
            margin-bottom: 1rem;
        }

        .supervisor-info .info-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .supervisor-info .info-row i {
            width: 20px;
            margin-right: 10px;
            text-align: center;
        }

        .worker-item {
            border-bottom: 1px solid rgba(0,0,0,.125);
            padding: 0.75rem 0.5rem; /* Tăng padding */
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Cho phép xuống dòng nếu cần */
            gap: 0.5rem; /* Khoảng cách giữa các phần tử */
        }

        .worker-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .worker-item .worker-name {
            display: flex;
            align-items: center;
            flex-grow: 1; /* Cho phép tên chiếm nhiều không gian hơn */
        }

        .worker-item .worker-name i {
            margin-right: 10px;
        }
        
        /* CSS cho thông tin contractor/field */
        .worker-item .worker-details {
            display: flex;
            flex-direction: column; /* Hiển thị contractor/field trên 2 dòng */
            align-items: flex-start; /* Căn trái */
            font-size: 0.85rem; /* Cỡ chữ nhỏ hơn */
            margin-left: 28px; /* Căn thẳng với tên worker */
            margin-top: -8px; /* Giảm khoảng cách với tên */
            margin-bottom: 5px;
        }
        
        .worker-item .worker-details .contractor-info,
        .worker-item .worker-details .field-info {
            display: flex;
            align-items: center;
            color: #6c757d; /* Màu text muted */
        }
        
        .worker-item .worker-details i {
             width: 16px;
             margin-right: 5px;
             text-align: center;
        }
        /* Kết thúc CSS */

        .worker-item .worker-actions {
            display: flex;
            align-items: center;
            flex-shrink: 0; /* Không cho phép co lại */
        }
        
        .worker-item .badge {
            margin-right: 0.5rem;
        }

        .worker-item .btn {
            padding: 0.2rem 0.5rem;
            margin-left: 0.25rem;
        }

        .action-buttons {
            white-space: nowrap;
        }
        
        /* CSS cho hiển thị và nút chọn nhà thầu trong modal */
        .selected-contractor-display, .selected-field-display {
             min-height: 38px;
             display: flex;
             align-items: center;
             background-color: #f8f9fa;
             padding: .375rem .75rem;
             border: 1px solid #ced4da;
             border-radius: .25rem;
             margin-bottom: 0.5rem; /* Khoảng cách với nút chọn */
        }
        
        .selected-field-display {
             border-left: 3px solid #17a2b8;
             padding-left: 10px;
             margin-bottom: 0; /* Không cần margin bottom cho field */
        }
        
        /* Nút chọn nhà thầu */
        .choose-contractor-btn {
             width: 100%;
             margin-bottom: 1rem;
        }
        
        .add-supervisor-card {
            display: flex;
            flex-direction: column;
            justify-content: center; /* căn giữa theo chiều dọc */
            align-items: center;     /* căn giữa theo chiều ngang */
            height: 100%;            /* hoặc đặt chiều cao cố định nếu cần */
            text-align: center;
            padding: 1rem;
            border: 1px solid #ccc;
            border-radius: 8px;
            transition: 0.3s;
            cursor: pointer;
        }
        
        .add-supervisor-card:hover {
            background-color: rgba(52, 152, 219, 0.1);
            border-color: #2980b9;
        }
        
        .add-supervisor-card i {
            font-size: 3rem;
            color: #3498db;
            margin-bottom: 1rem;
        }
        
        .add-supervisor-card h5 {
            color: #3498db;
            margin-bottom: 0;
        }
    </style>
    
    <!-- Thống kê trực quan -->
    <div class="row mb-4 justify-content-center">
        <div class="col-md-8">
            <div class="card border-primary shadow">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-chart-pie"></i> Thống kê tổng quan
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 text-center">
                            <div class="py-3 rounded mb-3">
                                <i class="fas fa-user-tie fa-3x mb-3 text-primary"></i>
                                <h2 class="counter display-4">{{ total_supervisors }}</h2>
                                <h5>Supervisor</h5>
                            </div>
                        </div>
                        <div class="col-md-6 text-center">
                            <div class="py-3 rounded mb-3">
                                <i class="fas fa-user fa-3x mb-3 text-success"></i>
                                <h2 class="counter display-4">{{ total_workers }}</h2>
                                <h5>Worker</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- Hiển thị danh sách Supervisor và Worker -->
    <div class="row">
        <!-- Card để thêm Supervisor mới -->
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card supervisor-card shadow-sm add-supervisor-card" id="add-supervisor-card">
                <div class="text-center">
                    <i class="fas fa-user-plus"></i>
                    <h5>Thêm Supervisor mới</h5>
                </div>
            </div>
        </div>
        
        {% for item in supervisor_data %}
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card border-success supervisor-card shadow-sm">
                <div class="card-header bg-success text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-user-tie me-2"></i>
                            <h5 class="supervisor-name mb-0">{{ item.supervisor.user.username }}</h5>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-light text-dark me-2">{{ item.worker_count }} worker</span>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-light edit-supervisor-btn" data-id="{{ item.supervisor.id }}" title="Sửa">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-supervisor-btn" data-id="{{ item.supervisor.id }}" data-name="{{ item.supervisor.user.username }}" title="Xóa">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="supervisor-info" id="supervisor-info-{{ item.supervisor.id }}">
                        <div class="info-row">
                            <i class="fas fa-envelope text-muted"></i>
                            <span class="text-muted">{{ item.supervisor.user.email|default:"Không có email" }}</span>
                        </div>
                        <div class="info-row">
                            <i class="fas fa-building text-muted"></i>
                            <span class="text-muted">{{ item.supervisor.company|default:"Không có công ty" }}</span>
                        </div>
                    </div>
                    
                    <div class="supervisor-edit-form d-none" id="supervisor-form-{{ item.supervisor.id }}">
                        <form class="mb-3 supervisor-form" data-id="{{ item.supervisor.id }}">
                            {% csrf_token %}
                            <input type="hidden" name="supervisor_id" value="{{ item.supervisor.id }}">
                            <div class="mb-2">
                                <label class="form-label"><i class="fas fa-envelope"></i> Email</label>
                                <input type="email" class="form-control form-control-sm" name="email" value="{{ item.supervisor.user.email|default:'' }}">
                            </div>
                            <div class="mb-2">
                                <label class="form-label"><i class="fas fa-building"></i> Công ty</label>
                                <input type="text" class="form-control form-control-sm" name="company" value="{{ item.supervisor.company|default:'' }}">
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-sm btn-secondary cancel-edit-btn" data-id="{{ item.supervisor.id }}">Hủy</button>
                                <button type="submit" class="btn btn-sm btn-primary">Lưu</button>
                            </div>
                        </form>
                    </div>
                    
                    <h6 class="border-bottom pb-2 mb-3 d-flex align-items-center justify-content-between">
                        <span><i class="fas fa-users me-2"></i>Danh sách Worker:</span>
                        <button class="btn btn-sm btn-outline-primary add-worker-btn" data-supervisor-id="{{ item.supervisor.id }}">
                            <i class="fas fa-plus"></i> Thêm
                        </button>
                    </h6>
                    
                    <div id="workers-list-{{ item.supervisor.id }}">
                        {% if item.workers %}
                            <div class="workers-container">
                                {% for worker in item.workers %}
                                <div class="worker-item" data-worker-id="{{ worker.id }}">
                                    <div>
                                    <div class="worker-name">
                                        <i class="fas fa-user text-secondary"></i>
                                        <span>{{ worker.user.username }}</span>
                                        </div>
                                        <!-- Thêm hiển thị contractor và field -->
                                        <div class="worker-details">
                                            <div class="contractor-info">
                                                <i class="fas fa-hard-hat"></i>
                                                <span>{{ worker.contractor|default:"Chưa có nhà thầu" }}</span>
                                            </div>
                                            <div class="field-info">
                                                 <i class="fas fa-tools"></i>
                                                 <span>{{ worker.field|default:"Chưa có lĩnh vực" }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="worker-actions">
                                        <span class="badge bg-primary text-white">{{ worker.company|default:"Chưa có" }}</span>
                                        <div class="action-buttons">
                                            <button class="btn btn-sm btn-outline-secondary edit-worker-btn" data-id="{{ worker.id }}" title="Sửa">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger delete-worker-btn" data-id="{{ worker.id }}" data-name="{{ worker.user.username }}" title="Xóa">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted text-center">
                                <i class="fas fa-info-circle"></i> Không có Worker nào được quản lý.
                            </p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <!-- Thêm clearfix sau mỗi 3 supervisor trên màn hình lớn và sau mỗi 2 trên màn hình trung bình -->
        {% if forloop.counter|divisibleby:3 %}
        <div class="clearfix clearfix-lg"></div>
        {% endif %}
        {% if forloop.counter|divisibleby:2 %}
        <div class="clearfix clearfix-md"></div>
        {% endif %}
        {% empty %}
        <div class="col-12">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i> Không tìm thấy Supervisor nào trong hệ thống.
                <button class="btn btn-warning ml-3" id="add-supervisor-btn-empty"> <!-- ID khác để tránh trùng -->
                    <i class="fas fa-plus"></i> Thêm Supervisor
                </button>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Hiển thị Worker không có Supervisor -->
    {% if has_unassigned %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-warning shadow-sm">
                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Worker chưa được phân công Supervisor</h5>
                    <button class="btn btn-sm btn-dark" id="add-worker-unassigned-btn"> <!-- ID khác -->
                        <i class="fas fa-plus"></i> Thêm Worker mới
                    </button>
                </div>
                <div class="card-body">
                    <div class="row" id="unassigned-workers-list">
                        {% for worker in workers_without_supervisor %}
                        <div class="col-md-3 mb-3">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <h6 class="card-title mb-2">
                                            <i class="fas fa-user text-warning"></i> {{ worker.user.username }}
                                        </h6>
                                    <!-- Thêm hiển thị contractor/field -->
                                    <div class="worker-details mb-2">
                                        <div class="contractor-info">
                                            <i class="fas fa-hard-hat"></i>
                                            <span>{{ worker.contractor|default:"Chưa có" }}</span>
                                    </div>
                                        <div class="field-info">
                                             <i class="fas fa-tools"></i>
                                             <span>{{ worker.field|default:"Chưa có" }}</span>
                                        </div>
                                    </div>
                                    <p class="card-text mb-2">
                                        <small class="text-muted">
                                            <i class="fas fa-building"></i> {{ worker.company|default:"Chưa có công ty" }}
                                        </small>
                                    </p>
                                    <div class="d-flex justify-content-between">
                                        <button class="btn btn-sm btn-outline-success assign-worker-btn" data-id="{{ worker.id }}">Phân công</button>
                                        <button class="btn btn-sm btn-outline-secondary edit-unassigned-btn" data-id="{{ worker.id }}"><i class="fas fa-edit"></i></button>
                                        <button class="btn btn-sm btn-outline-danger delete-worker-btn" data-id="{{ worker.id }}" data-name="{{ worker.user.username }}"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="row mt-4 justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body text-center">
                    <p class="mb-2">Tất cả Worker đã được phân công Supervisor.</p>
                    <button class="btn btn-primary" id="add-worker-all-assigned-btn"> <!-- ID khác -->
                        <i class="fas fa-plus"></i> Thêm Worker mới
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal thêm Supervisor -->
<div class="modal fade" id="addSupervisorModal" tabindex="-1" aria-labelledby="addSupervisorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSupervisorModalLabel">Thêm Supervisor mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="add-supervisor-form">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="supervisor-username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="supervisor-username" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="supervisor-email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="supervisor-email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="supervisor-company" class="form-label">Công ty</label>
                        <input type="text" class="form-control" id="supervisor-company" name="company">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                 <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="save-supervisor-btn">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal thêm Worker -->
<div class="modal fade" id="addWorkerModal" tabindex="-1" aria-labelledby="addWorkerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addWorkerModalLabel">Thêm Worker mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="add-worker-form">
                    {% csrf_token %}
                    <input type="hidden" id="worker-supervisor-id" name="supervisor_id" value="">
                    <!-- Thêm input ẩn cho contractor và field -->
                    <input type="hidden" id="add-worker-contractor-input" name="contractor">
                    <input type="hidden" id="add-worker-field-input" name="field">
                    
                    <div class="mb-3">
                        <label for="worker-username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="worker-username" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="worker-company" class="form-label">Công ty</label>
                        <input type="text" class="form-control" id="worker-company" name="company">
                    </div>
                     <!-- Phần chọn Nhà thầu/Lĩnh vực -->
                    <div class="mb-3 border p-3 rounded">
                         <h6 class="mb-3">Thông tin Nhà thầu/Lĩnh vực</h6>
                         <div class="selected-contractor-display" id="add-selected-contractor-display">
                              <em class="text-muted">Chưa chọn nhà thầu</em>
                         </div>
                         <div class="selected-field-display" id="add-selected-field-display">
                              <em class="text-muted">Chưa có lĩnh vực</em>
                         </div>
                         <button type="button" class="btn btn-primary mt-2 choose-contractor-btn" data-target-modal="addWorkerModal">
                              <i class="fas fa-building"></i> Chọn/Quản lý Nhà thầu
                         </button>
                    </div>
                    <!-- Kết thúc phần chọn Nhà thầu/Lĩnh vực -->
                    <div class="mb-3">
                        <label for="worker-supervisor" class="form-label">Supervisor</label>
                        <select class="form-select" id="worker-supervisor" name="supervisor"> <!-- Bỏ name="supervisor_id" ở đây -->
                            <option value="">-- Chưa phân công --</option>
                            {% for item in supervisor_data %}
                            <option value="{{ item.supervisor.id }}">{{ item.supervisor.user.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                 <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="save-worker-btn">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal phân công Worker -->
<div class="modal fade" id="assignWorkerModal" tabindex="-1" aria-labelledby="assignWorkerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignWorkerModalLabel">Phân công Worker cho Supervisor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="assign-worker-form">
                    {% csrf_token %}
                    <input type="hidden" id="assign-worker-id" name="worker_id" value="">
                    <div class="mb-3">
                        <label for="assign-supervisor" class="form-label">Chọn Supervisor</label>
                        <select class="form-select" id="assign-supervisor" name="supervisor_id" required>
                            <option value="">-- Chọn Supervisor --</option>
                            {% for item in supervisor_data %}
                            <option value="{{ item.supervisor.id }}">{{ item.supervisor.user.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                 <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="save-assignment-btn">Phân công</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal chỉnh sửa Worker -->
<div class="modal fade" id="editWorkerModal" tabindex="-1" aria-labelledby="editWorkerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editWorkerModalLabel">Chỉnh sửa thông tin Worker</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="edit-worker-form">
                    {% csrf_token %}
                    <input type="hidden" id="edit-worker-id" name="worker_id" value="">
                    <!-- Thêm input ẩn cho contractor và field -->
                    <input type="hidden" id="edit-worker-contractor-input" name="contractor">
                    <input type="hidden" id="edit-worker-field-input" name="field">
                    
                    <div class="mb-3">
                        <label for="edit-worker-username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="edit-worker-username" name="username" readonly> <!-- Giữ readonly -->
                    </div>
                    <div class="mb-3">
                        <label for="edit-worker-company" class="form-label">Công ty</label>
                        <input type="text" class="form-control" id="edit-worker-company" name="company">
                    </div>
                    <!-- Phần chọn Nhà thầu/Lĩnh vực -->
                    <div class="mb-3 border p-3 rounded">
                         <h6 class="mb-3">Thông tin Nhà thầu/Lĩnh vực</h6>
                         <div class="selected-contractor-display" id="edit-selected-contractor-display">
                              <em class="text-muted">Chưa chọn nhà thầu</em>
                         </div>
                         <div class="selected-field-display" id="edit-selected-field-display">
                              <em class="text-muted">Chưa có lĩnh vực</em>
                         </div>
                         <button type="button" class="btn btn-primary mt-2 choose-contractor-btn" data-target-modal="editWorkerModal">
                              <i class="fas fa-building"></i> Chọn/Quản lý Nhà thầu
                         </button>
                    </div>
                    <!-- Kết thúc phần chọn Nhà thầu/Lĩnh vực -->
                    <div class="mb-3">
                        <label for="edit-worker-supervisor" class="form-label">Supervisor</label>
                        <select class="form-select" id="edit-worker-supervisor" name="supervisor_id">
                            <option value="">-- Chưa phân công --</option>
                            {% for item in supervisor_data %}
                            <option value="{{ item.supervisor.id }}">{{ item.supervisor.user.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                 <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="update-worker-btn">Cập nhật</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Quản lý Nhà thầu (Sao chép từ process_video_roi.html) -->
<div class="modal fade" id="contractors-manager-modal" tabindex="-1" role="dialog" aria-labelledby="contractorsManagerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="contractorsManagerModalLabel">Quản lý Danh sách Nhà thầu và Lĩnh vực</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"> <!-- Giữ data-dismiss -->
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <p class="mb-0">Chức năng này cho phép bạn quản lý danh sách nhà thầu và lĩnh vực công việc. Nhấn vào <i class="fas fa-check"></i> <b>Chọn</b> để sử dụng thông tin cho Worker đang được thêm/sửa.</p>
                </div>
                
                <!-- Form thêm mới nhà thầu và lĩnh vực -->
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">Thêm mới</h6>
                        <div class="form-row">
                            <div class="col-md-5 mb-2">
                                <input type="text" class="form-control" id="new-contractor-name" placeholder="Tên nhà thầu">
                            </div>
                            <div class="col-md-5 mb-2">
                                <input type="text" class="form-control" id="new-contractor-field" placeholder="Lĩnh vực công việc">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-success btn-block" id="add-contractor-btn">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tìm kiếm -->
                <div class="form-group">
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                        </div>
                        <input type="text" class="form-control" id="contractor-search" placeholder="Tìm kiếm...">
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped table-bordered" id="contractors-table">
                        <thead>
                            <tr>
                                <th>Tên nhà thầu</th>
                                <th>Lĩnh vực</th>
                                <th class="text-center">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Danh sách nhà thầu sẽ được thêm ở đây bằng JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button> <!-- Giữ data-dismiss -->
            </div>
        </div>
    </div>
</div>
<!-- Kết thúc Modal Quản lý Nhà thầu -->

{% endblock %}

{% block extrajs %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <!-- Thêm SweetAlert2 -->
<script>
    $(document).ready(function() {
        // --- Selectors ---
        var addWorkerModal = $('#addWorkerModal');
        var editWorkerModal = $('#editWorkerModal');
        var contractorsManagerModal = $('#contractors-manager-modal');
        
        // Input ẩn và hiển thị trong Add Worker Modal
        var addContractorInput = $('#add-worker-contractor-input');
        var addFieldInput = $('#add-worker-field-input');
        var addSelectedContractorDisplay = $('#add-selected-contractor-display');
        var addSelectedFieldDisplay = $('#add-selected-field-display');
        
        // Input ẩn và hiển thị trong Edit Worker Modal
        var editContractorInput = $('#edit-worker-contractor-input');
        var editFieldInput = $('#edit-worker-field-input');
        var editSelectedContractorDisplay = $('#edit-selected-contractor-display');
        var editSelectedFieldDisplay = $('#edit-selected-field-display');
        
        // Biến lưu trữ modal nào đang mở để cập nhật đúng input
        var activeWorkerModal = null;

        // Hiệu ứng đếm số
        $('.counter').each(function() {
            $(this).prop('Counter', 0).animate({
                Counter: $(this).text()
            }, {
                duration: 1500,
                easing: 'swing',
                step: function(now) {
                    $(this).text(Math.ceil(now));
                }
            });
        });
        
        // Xử lý sự kiện khi nhấp vào card thêm Supervisor mới
        $('#add-supervisor-card, #add-supervisor-btn-empty').click(function() { // Thêm ID mới
            $('#addSupervisorModal').modal('show');
        });
        
        // Xử lý khi click vào Edit cho supervisor
        $('.edit-supervisor-btn').click(function() {
            const id = $(this).data('id');
            $(`#supervisor-info-${id}`).addClass('d-none');
            $(`#supervisor-form-${id}`).removeClass('d-none');
        });
        
        // Xử lý khi click Hủy chỉnh sửa supervisor
        $('.cancel-edit-btn').click(function() {
            const id = $(this).data('id');
            $(`#supervisor-form-${id}`).addClass('d-none');
            $(`#supervisor-info-${id}`).removeClass('d-none');
        });
        
        // Xử lý submit form chỉnh sửa supervisor
        $('.supervisor-form').submit(function(e) {
            e.preventDefault();
            const id = $(this).data('id');
            const formData = $(this).serialize();
            
            $.ajax({
                url: '{% url "update-supervisor" %}',
                type: 'POST',
                data: formData,
                success: function(response) {
                    if (response.status === 'success') {
                        location.reload(); // Tạm thời reload trang
                    } else {
                         Swal.fire('Lỗi!', response.message || 'Không thể cập nhật Supervisor.', 'error');
                    }
                },
                error: function() {
                     Swal.fire('Lỗi!', 'Đã xảy ra lỗi khi kết nối.', 'error');
                }
            });
        });
        
        // Mở modal thêm Supervisor
        $('#add-supervisor-btn').click(function() { // Giữ lại ID gốc nếu cần
            $('#addSupervisorModal').modal('show');
        });
        
        // Lưu Supervisor mới
        $('#save-supervisor-btn').click(function() {
            const form = $('#add-supervisor-form');
            if (form[0].checkValidity() === false) {
                 form[0].reportValidity();
                 return;
            }
            const formData = form.serialize();
            
            $.ajax({
                url: '{% url "add-supervisor" %}',
                type: 'POST',
                data: formData,
                success: function(response) {
                    if (response.status === 'success') {
                        $('#addSupervisorModal').modal('hide');
                        Swal.fire('Thành công!', 'Đã thêm Supervisor mới.', 'success').then(() => location.reload());
                    } else {
                         Swal.fire('Lỗi!', response.message || 'Không thể thêm Supervisor.', 'error');
                    }
                },
                error: function() {
                    Swal.fire('Lỗi!', 'Đã xảy ra lỗi khi kết nối.', 'error');
                }
            });
        });
        
        // Mở modal thêm Worker
        $('#add-worker-btn, .add-worker-btn, #add-worker-unassigned-btn, #add-worker-all-assigned-btn').click(function() { // Thêm các ID mới
            const supervisorId = $(this).data('supervisor-id') || '';
            $('#worker-supervisor-id').val(supervisorId); // Set hidden input
            $('#worker-supervisor').val(supervisorId);   // Set select dropdown
            
            // Reset form và contractor fields
            $('#add-worker-form')[0].reset();
            $('#worker-supervisor-id').val(supervisorId); // Re-set hidden supervisor id
            $('#worker-supervisor').val(supervisorId); // Re-set select dropdown
            addContractorInput.val('');
            addFieldInput.val('');
            addSelectedContractorDisplay.html('<em class="text-muted">Chưa chọn nhà thầu</em>');
            addSelectedFieldDisplay.html('<em class="text-muted">Chưa có lĩnh vực</em>');
            
            activeWorkerModal = addWorkerModal; // Đặt modal hiện tại là Add
            addWorkerModal.modal('show');
        });
        
        // Lưu Worker mới
        $('#save-worker-btn').click(function() {
            const form = $('#add-worker-form');
            if (form[0].checkValidity() === false) {
                 form[0].reportValidity();
                 return;
            }
            // Lấy supervisor_id từ select box thay vì input ẩn
            const supervisorSelectVal = $('#worker-supervisor').val();
            $('#worker-supervisor-id').val(supervisorSelectVal); // Cập nhật input ẩn trước khi serialize

            const formData = form.serialize();
            
            $.ajax({
                url: '{% url "add-worker" %}', // Đã cập nhật ở backend để nhận contractor/field
                type: 'POST',
                data: formData,
                success: function(response) {
                    if (response.status === 'success') {
                        addWorkerModal.modal('hide');
                        Swal.fire('Thành công!', 'Đã thêm Worker mới.', 'success').then(() => location.reload());
                    } else {
                        Swal.fire('Lỗi!', response.message || 'Không thể thêm Worker.', 'error');
                    }
                },
                error: function() {
                    Swal.fire('Lỗi!', 'Đã xảy ra lỗi khi kết nối.', 'error');
                }
            });
        });
        
        // Mở modal phân công Worker
        $('.assign-worker-btn').click(function() {
            const workerId = $(this).data('id');
            $('#assign-worker-id').val(workerId);
            $('#assign-worker-form')[0].reset(); // Reset select
            $('#assignWorkerModal').modal('show');
        });
        
        // Lưu phân công Worker
        $('#save-assignment-btn').click(function() {
            const form = $('#assign-worker-form');
             if (form[0].checkValidity() === false) {
                 form[0].reportValidity();
                 return;
            }
            const formData = form.serialize();
            
            $.ajax({
                url: '{% url "assign-worker" %}',
                type: 'POST',
                data: formData,
                success: function(response) {
                    if (response.status === 'success') {
                        $('#assignWorkerModal').modal('hide');
                         Swal.fire('Thành công!', 'Đã phân công Worker.', 'success').then(() => location.reload());
                    } else {
                         Swal.fire('Lỗi!', response.message || 'Không thể phân công Worker.', 'error');
                    }
                },
                error: function() {
                    Swal.fire('Lỗi!', 'Đã xảy ra lỗi khi kết nối.', 'error');
                }
            });
        });
        
        // Mở modal chỉnh sửa Worker
        $('.edit-worker-btn, .edit-unassigned-btn').click(function() {
            const workerId = $(this).data('id');
            
            // Lấy thông tin Worker (đã bao gồm contractor/field)
            $.ajax({
                url: '{% url "get-worker-info" %}', // Đã cập nhật backend
                type: 'GET',
                data: { worker_id: workerId },
                success: function(response) {
                    if (response.status === 'success') {
                        $('#edit-worker-id').val(workerId);
                        $('#edit-worker-username').val(response.data.username);
                        $('#edit-worker-company').val(response.data.company);
                        $('#edit-worker-supervisor').val(response.data.supervisor_id);
                        
                        // Cập nhật contractor và field
                        editContractorInput.val(response.data.contractor);
                        editFieldInput.val(response.data.field);
                        
                        if (response.data.contractor) {
                             editSelectedContractorDisplay.html(`<strong>${escapeHtml(response.data.contractor)}</strong>`);
                    } else {
                             editSelectedContractorDisplay.html('<em class="text-muted">Chưa chọn nhà thầu</em>');
                        }
                        if (response.data.field) {
                             editSelectedFieldDisplay.html(`<strong>${escapeHtml(response.data.field)}</strong>`);
                        } else {
                             editSelectedFieldDisplay.html('<em class="text-muted">Chưa có lĩnh vực</em>');
                        }
                        
                        activeWorkerModal = editWorkerModal; // Đặt modal hiện tại là Edit
                        editWorkerModal.modal('show');
                    } else {
                         Swal.fire('Lỗi!', response.message || 'Không thể lấy thông tin Worker.', 'error');
                    }
                },
                error: function() {
                    Swal.fire('Lỗi!', 'Đã xảy ra lỗi khi kết nối.', 'error');
                }
            });
        });
        
        // Cập nhật thông tin Worker
        $('#update-worker-btn').click(function() {
            const form = $('#edit-worker-form');
            if (form[0].checkValidity() === false) {
                 form[0].reportValidity();
                 return;
            }
            const formData = form.serialize();
            
            $.ajax({
                url: '{% url "update-worker" %}', // Đã cập nhật backend
                type: 'POST',
                data: formData,
                success: function(response) {
                    if (response.status === 'success') {
                        editWorkerModal.modal('hide');
                        Swal.fire('Thành công!', 'Đã cập nhật thông tin Worker.', 'success').then(() => location.reload());
                    } else {
                        Swal.fire('Lỗi!', response.message || 'Không thể cập nhật Worker.', 'error');
                    }
                },
                error: function() {
                    Swal.fire('Lỗi!', 'Đã xảy ra lỗi khi kết nối.', 'error');
                }
            });
        });

        // === Xử lý nút Đồng bộ Firebase ===
        $('#sync-firebase-btn').click(function() {
            const button = $(this);
            button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Đang đồng bộ...');
            const csrfToken = $('input[name="csrfmiddlewaretoken"]').val(); 

            Swal.fire({
                title: 'Xác nhận đồng bộ?',
                text: "Cập nhật toàn bộ danh sách worker-supervisor lên Firestore?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Đồng ý!',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '{% url "sync-supervisor-worker-firebase" %}', 
                        type: 'POST',
                        headers: { "X-CSRFToken": csrfToken }, 
                        dataType: 'json',
                        success: function(response) {
                            button.prop('disabled', false).html('<i class="fas fa-sync-alt"></i> Đồng bộ lên Firebase');
                            if (response.status === 'success') {
                                Swal.fire('Thành công!', response.message || 'Đồng bộ thành công.', 'success');
                            } else {
                                Swal.fire('Lỗi!', response.message || 'Có lỗi xảy ra.', 'error');
                            }
                        },
                        error: function() {
                            button.prop('disabled', false).html('<i class="fas fa-sync-alt"></i> Đồng bộ lên Firebase');
                            Swal.fire('Lỗi Kết Nối!', 'Không thể kết nối server.', 'error');
                        }
                    });
                } else {
                    button.prop('disabled', false).html('<i class="fas fa-sync-alt"></i> Đồng bộ lên Firebase');
                }
            });
        });
        // === Kết thúc xử lý nút Đồng bộ Firebase ===

        // =========================================== //
        // === JavaScript Quản lý Nhà thầu (Contractor) === //
        // =========================================== //

        // Hàm lưu danh sách nhà thầu vào localStorage và Firebase
        function saveContractorsToStorage() {
            var contractors = [];
            $('#contractors-table tbody tr').each(function() {
                 // Bỏ qua hàng đang ở chế độ sửa
                 if ($(this).find('.save-edit-btn').length === 0) {
                    contractors.push({
                        name: $(this).data('contractor'),
                        field: $(this).data('field') || '' // Đảm bảo field là string
                    });
                 }
            });
            localStorage.setItem('contractors_list', JSON.stringify(contractors));
            saveContractorsToFirebase(contractors); // Gọi hàm đồng bộ Firebase
        }

        // Hàm đồng bộ danh sách nhà thầu lên Firebase
        function saveContractorsToFirebase(contractors) {
            const csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
                    $.ajax({
                url: "{% url 'save-contractor-to-firebase' %}", // URL đã tạo
                type: "POST",
                data: JSON.stringify({ contractors: contractors }),
                contentType: "application/json",
                        headers: { "X-CSRFToken": csrfToken },
                        success: function(response) {
                    console.log("[Firebase] Đồng bộ nhà thầu thành công:", response);
                    // Có thể thêm thông báo nhỏ ở góc màn hình
                    // Toastify({ text: "Đã đồng bộ nhà thầu lên Firebase.", duration: 2000, gravity: "bottom", position: "right" }).showToast();
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("[Firebase] Lỗi khi đồng bộ nhà thầu:", textStatus, errorThrown);
                    // Có thể thêm thông báo lỗi
                     Swal.fire('Lỗi Firebase!', 'Không thể đồng bộ danh sách nhà thầu.', 'error');
                }
            });
        }

        // Hàm tải danh sách nhà thầu từ localStorage vào bảng
        function loadContractorsFromLocalStorage() {
            var contractorsJson = localStorage.getItem('contractors_list');
            var tableBody = $('#contractors-table tbody');
            tableBody.empty(); // Xóa nội dung cũ
            if (contractorsJson) {
                try {
                    var contractors = JSON.parse(contractorsJson);
                    contractors.forEach(function(contractor) {
                        addContractorRow(tableBody, contractor.name, contractor.field);
                    });
                } catch (e) {
                    console.error("Lỗi khi tải danh sách nhà thầu:", e);
                    localStorage.removeItem('contractors_list'); // Xóa dữ liệu lỗi
                }
            }
        }

        // Hàm thêm một hàng vào bảng nhà thầu
        function addContractorRow(tableBody, name, field) {
            var fieldDisplay = field ? field : '<em class="text-muted">Chưa có</em>';
            var newRow = `
                <tr data-contractor="${escapeHtml(name)}" data-field="${escapeHtml(field || '')}">
                    <td class="contractor-name-cell">${escapeHtml(name)}</td>
                    <td class="contractor-field-cell">${fieldDisplay}</td>
                    <td class="text-center action-buttons">
                        <button class="btn btn-sm btn-primary select-contractor-btn" title="Chọn nhà thầu này">
                            <i class="fas fa-check"></i> Chọn
                        </button>
                        <button class="btn btn-sm btn-secondary edit-contractor-btn" title="Sửa thông tin">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger delete-contractor-btn" title="Xóa nhà thầu">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            tableBody.append(newRow);
        }
        
        // Hàm escape HTML để tránh XSS
        function escapeHtml(unsafe) {
             if (typeof unsafe !== 'string') return unsafe;
             return unsafe
                  .replace(/&/g, "&amp;")
                  .replace(/</g, "&lt;")
                  .replace(/>/g, "&gt;")
                  .replace(/"/g, "&quot;")
                  .replace(/'/g, "&#039;");
         }

        // Mở modal quản lý nhà thầu khi nhấn nút "Chọn/Quản lý Nhà thầu"
        $('.choose-contractor-btn').click(function() {
            var targetModalId = $(this).data('target-modal');
            // Xác định modal nào đang mở (Add hay Edit) để cập nhật đúng input sau này
            if (targetModalId === 'addWorkerModal') {
                 activeWorkerModal = addWorkerModal;
            } else if (targetModalId === 'editWorkerModal') {
                 activeWorkerModal = editWorkerModal;
                            } else {
                 activeWorkerModal = null; // Không xác định
            }
            console.log("Active worker modal set to:", targetModalId);
            loadContractorsFromLocalStorage(); // Tải danh sách nhà thầu
            contractorsManagerModal.modal('show');
        });

        // Tìm kiếm nhà thầu trong bảng
        $('#contractor-search').on('keyup', function() {
            var value = $(this).val().toLowerCase();
            $('#contractors-table tbody tr').filter(function() {
                // Đảm bảo không tìm kiếm trong input khi đang sửa
                if ($(this).find('input').length > 0) {
                    return true; // Luôn hiển thị hàng đang sửa
                }
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
            });
        });

        // Thêm nhà thầu mới vào bảng
        $('#add-contractor-btn').click(function() {
            var contractorNameInput = $('#new-contractor-name');
            var fieldValueInput = $('#new-contractor-field');
            var contractorName = contractorNameInput.val().trim();
            var fieldValue = fieldValueInput.val().trim();
            
            if (!contractorName) {
                Swal.fire('Thiếu thông tin', 'Vui lòng nhập tên nhà thầu!', 'warning');
                contractorNameInput.focus();
                return;
            }
            
            // Kiểm tra trùng lặp tên nhà thầu
            var isDuplicate = false;
            $('#contractors-table tbody tr').each(function() {
                // So sánh với data-contractor, không phải text() để chính xác cả khi đang sửa
                if ($(this).data('contractor') === contractorName) {
                    isDuplicate = true;
                    return false; // Thoát vòng lặp .each
                }
            });
            
            if (isDuplicate) {
                 Swal.fire('Trùng lặp', 'Nhà thầu này đã tồn tại!', 'warning');
                 return;
            }
            
            // Thêm hàng mới
            addContractorRow($('#contractors-table tbody'), contractorName, fieldValue);
            
            // Xóa giá trị nhập
            contractorNameInput.val('');
            fieldValueInput.val('');
            
            // Lưu danh sách nhà thầu
            saveContractorsToStorage();
        });

        // Xử lý sự kiện chọn nhà thầu từ modal quản lý
        $(document).on('click', '.select-contractor-btn', function() {
            var row = $(this).closest('tr');
            var contractorName = row.data('contractor');
            var fieldValue = row.data('field'); // Lấy từ data-field
            
            console.log("Selected contractor:", contractorName, "Field:", fieldValue);
            console.log("Updating inputs for modal:", activeWorkerModal ? activeWorkerModal.attr('id') : 'None');

            // Cập nhật input và hiển thị dựa trên modal đang hoạt động
            if (activeWorkerModal && activeWorkerModal.attr('id') === 'addWorkerModal') {
                 addContractorInput.val(contractorName);
                 addFieldInput.val(fieldValue);
                 addSelectedContractorDisplay.html(`<strong>${escapeHtml(contractorName)}</strong>`);
                 addSelectedFieldDisplay.html(fieldValue ? `<strong>${escapeHtml(fieldValue)}</strong>` : '<em class="text-muted">Chưa có lĩnh vực</em>');
            } else if (activeWorkerModal && activeWorkerModal.attr('id') === 'editWorkerModal') {
                 editContractorInput.val(contractorName);
                 editFieldInput.val(fieldValue);
                 editSelectedContractorDisplay.html(`<strong>${escapeHtml(contractorName)}</strong>`);
                 editSelectedFieldDisplay.html(fieldValue ? `<strong>${escapeHtml(fieldValue)}</strong>` : '<em class="text-muted">Chưa có lĩnh vực</em>');
            } else {
                 console.warn("Không xác định được modal mục tiêu để cập nhật nhà thầu.");
                 // Có thể hiển thị thông báo lỗi nếu cần
            }
            
            // Đóng modal quản lý nhà thầu
            contractorsManagerModal.modal('hide');
        });
        
        // Xử lý sự kiện sửa nhà thầu
        $(document).on('click', '.edit-contractor-btn', function() {
             var row = $(this).closest('tr');
             // Nếu đã ở chế độ sửa thì không làm gì
             if (row.find('.save-edit-btn').length > 0) return;
             
             var contractorName = row.data('contractor');
             var fieldValue = row.data('field'); // Lấy từ data-field
             
             // Lưu lại nội dung cũ để có thể hủy
             row.data('original-html', row.html());
             
             // Thay đổi nội dung hàng thành input
             row.html(`
                <td>
                    <input type="text" class="form-control form-control-sm edit-contractor-name" value="${escapeHtml(contractorName)}">
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm edit-contractor-field" value="${escapeHtml(fieldValue || '')}">
                </td>
                <td class="text-center action-buttons">
                    <button class="btn btn-sm btn-success save-edit-btn" title="Lưu thay đổi">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="btn btn-sm btn-secondary cancel-edit-btn" title="Hủy thay đổi">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
             `);
             row.find('.edit-contractor-name').focus(); // Focus vào input tên
        });

        // Lưu chỉnh sửa nhà thầu
        $(document).on('click', '.save-edit-btn', function() {
            var row = $(this).closest('tr');
            var oldName = row.data('contractor'); // Lấy tên cũ từ data attribute
            var newNameInput = row.find('.edit-contractor-name');
            var newFieldInput = row.find('.edit-contractor-field');
            var newName = newNameInput.val().trim();
            var newField = newFieldInput.val().trim();
            
            if (!newName) {
                Swal.fire('Thiếu thông tin', 'Tên nhà thầu không được để trống!', 'warning');
                newNameInput.focus();
                return;
            }
            
            // Kiểm tra trùng lặp nếu tên thay đổi
            if (oldName !== newName) {
                var isDuplicate = false;
                $('#contractors-table tbody tr').not(row).each(function() {
                    if ($(this).data('contractor') === newName) {
                        isDuplicate = true;
                        return false;
                    }
                });
                
                if (isDuplicate) {
                    Swal.fire('Trùng lặp', 'Nhà thầu này đã tồn tại!', 'warning');
                    return;
                }
            }
            
            // Cập nhật data attribute trước khi thay đổi HTML
            row.data('contractor', newName);
            row.data('field', newField);
            
            // Cập nhật hiển thị hàng về trạng thái bình thường
            var fieldDisplay = newField ? escapeHtml(newField) : '<em class="text-muted">Chưa có</em>';
            row.html(`
                <td class="contractor-name-cell">${escapeHtml(newName)}</td>
                <td class="contractor-field-cell">${fieldDisplay}</td>
                <td class="text-center action-buttons">
                     <button class="btn btn-sm btn-primary select-contractor-btn" title="Chọn nhà thầu này">
                         <i class="fas fa-check"></i> Chọn
                     </button>
                    <button class="btn btn-sm btn-secondary edit-contractor-btn" title="Sửa thông tin">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger delete-contractor-btn" title="Xóa nhà thầu">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `);
            
            // Cập nhật giá trị hiển thị trong Add/Edit modal nếu đang chọn nhà thầu này
            if (activeWorkerModal) {
                 let currentContractorInput, currentFieldInput, currentContractorDisplay, currentFieldDisplay;
                 if (activeWorkerModal.attr('id') === 'addWorkerModal') {
                      currentContractorInput = addContractorInput;
                      currentFieldInput = addFieldInput;
                      currentContractorDisplay = addSelectedContractorDisplay;
                      currentFieldDisplay = addSelectedFieldDisplay;
                 } else if (activeWorkerModal.attr('id') === 'editWorkerModal') {
                      currentContractorInput = editContractorInput;
                      currentFieldInput = editFieldInput;
                      currentContractorDisplay = editSelectedContractorDisplay;
                      currentFieldDisplay = editSelectedFieldDisplay;
                 }
                 
                 if (currentContractorInput && currentContractorInput.val() === oldName) {
                      currentContractorInput.val(newName);
                      currentFieldInput.val(newField);
                      currentContractorDisplay.html(`<strong>${escapeHtml(newName)}</strong>`);
                      currentFieldDisplay.html(newField ? `<strong>${escapeHtml(newField)}</strong>` : '<em class="text-muted">Chưa có lĩnh vực</em>');
                 }
            }
            
            // Lưu danh sách nhà thầu
            saveContractorsToStorage();
        });
        
        // Hủy chỉnh sửa nhà thầu
        $(document).on('click', '.cancel-edit-btn', function() {
            var row = $(this).closest('tr');
            var originalHtml = row.data('original-html');
            if (originalHtml) {
                 row.html(originalHtml); // Khôi phục HTML cũ
            } else {
                 // Fallback nếu không có original-html (trường hợp hiếm)
                 var contractorName = row.data('contractor');
                 var fieldValue = row.data('field') || '';
                 var fieldDisplay = fieldValue ? escapeHtml(fieldValue) : '<em class="text-muted">Chưa có</em>';
                 row.html(`
                    <td class="contractor-name-cell">${escapeHtml(contractorName)}</td>
                    <td class="contractor-field-cell">${fieldDisplay}</td>
                     <td class="text-center action-buttons">
                         <button class="btn btn-sm btn-primary select-contractor-btn" title="Chọn nhà thầu này">
                              <i class="fas fa-check"></i> Chọn
                         </button>
                         <button class="btn btn-sm btn-secondary edit-contractor-btn" title="Sửa thông tin">
                             <i class="fas fa-edit"></i>
                         </button>
                         <button class="btn btn-sm btn-danger delete-contractor-btn" title="Xóa nhà thầu">
                             <i class="fas fa-trash"></i>
                         </button>
                     </td>
                 `);
            }
        });
        
        // Xóa nhà thầu
        $(document).on('click', '.delete-contractor-btn', function() {
            var row = $(this).closest('tr');
            var contractorName = row.data('contractor');
            
            Swal.fire({
                title: 'Xác nhận xóa?',
                html: `Bạn có chắc muốn xóa nhà thầu <strong>${escapeHtml(contractorName)}</strong>?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy bỏ'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Cập nhật giá trị hiển thị trong Add/Edit modal nếu đang chọn nhà thầu này TRƯỚC KHI xóa hàng
                    if (activeWorkerModal) {
                         let currentContractorInput, currentFieldInput, currentContractorDisplay, currentFieldDisplay;
                         if (activeWorkerModal.attr('id') === 'addWorkerModal') {
                              currentContractorInput = addContractorInput;
                              currentFieldInput = addFieldInput;
                              currentContractorDisplay = addSelectedContractorDisplay;
                              currentFieldDisplay = addSelectedFieldDisplay;
                         } else if (activeWorkerModal.attr('id') === 'editWorkerModal') {
                              currentContractorInput = editContractorInput;
                              currentFieldInput = editFieldInput;
                              currentContractorDisplay = editSelectedContractorDisplay;
                              currentFieldDisplay = editSelectedFieldDisplay;
                         }
                         
                         if (currentContractorInput && currentContractorInput.val() === contractorName) {
                              currentContractorInput.val('');
                              currentFieldInput.val('');
                              currentContractorDisplay.html('<em class="text-muted">Chưa chọn nhà thầu</em>');
                              currentFieldDisplay.html('<em class="text-muted">Chưa có lĩnh vực</em>');
                         }
                    }
                    
                    // Xóa hàng khỏi bảng
                    row.remove();
                    
                    // Lưu danh sách nhà thầu
                    saveContractorsToStorage();
                    
                    Swal.fire('Đã xóa!', `Nhà thầu ${escapeHtml(contractorName)} đã được xóa.`, 'success');
                }
            });
        });

        // Tải danh sách nhà thầu lần đầu khi trang tải
        // loadContractorsFromLocalStorage(); // Bỏ dòng này, chỉ tải khi mở modal

        // =========================================== //
        // === Kết thúc JavaScript Quản lý Nhà thầu === //
        // =========================================== //

    });
</script>
{% endblock %} 