{% extends 'recognition/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Xử lý Video và Chấm công{% endblock %}

{% block extra_head %}
    <!-- Thêm các link CSS hoặc script cần trong head vào đây -->
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@x.x.x/dist/select2-bootstrap4.min.css" rel="stylesheet" />
    <!-- Cropper.js CSS (Local) -->
    <link rel="stylesheet" href="{% static 'recognition/vendor/cropperjs/cropper.min.css' %}">
    <!-- Toastify CSS (Thêm nếu dùng thông báo nhỏ) -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <style>
        /* Giữ lại các style đặc trưng cho trang này */
        .card {
            margin-bottom: 1.5rem;
        }
        .video-card .card-body {
            padding: 0.5rem;
        }
        .roi-status {
            margin-bottom: 1rem;
            padding: 0.75rem 1.25rem;
            border: 1px solid transparent;
            border-radius: 0.25rem;
        }
        .roi-status-selected {
            color: #0f5132;
            background-color: #d1e7dd;
            border-color: #badbcc;
        }
        .roi-status-not-selected {
            color: #664d03;
            background-color: #fff3cd;
            border-color: #ffecb5;
        }
        .camera-section .form-group {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .camera-section .form-group > div {
             flex-grow: 1;
        }
        .camera-section .btn-sm {
             margin-top: 5px;
        }
        .table-responsive {
            margin-top: 1rem; /* Giảm margin top bảng log */
        }
        .video-container {
            position: relative;
            width: 100%;
            background-color: #222;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: .25rem;
        }
        .video-container img {
            height: auto;
            display: block;
            max-width: 100%;
            max-height: 75vh;
            margin: 0 auto;
        }
        .video-placeholder-text {
            position: absolute;
            color: #aaa;
            text-align: center;
            font-size: 1.2rem;
            padding: 2rem;
        }
        .video-container img[src*="video-feed"] + .video-placeholder-text {
            display: none;
        }
        .is-streaming .video-placeholder-text {
             display: none;
        }
        #username-field-group:not(.mode-collect) {
            display: none;
        }
        .control-buttons button {
            margin-right: 5px;
        }
        #div_id_username.moved-username-field {
            margin-left: 25px; 
            margin-top: 5px;
            margin-bottom: 15px; 
            border-left: 2px solid #eee; 
            padding-left: 15px;
            padding-top: 5px;
        }
        .attendance-table img {
            max-width: 50px;
            max-height: 50px;
            border-radius: 4px;
        }
        .attendance-table th, .attendance-table td {
             vertical-align: middle;
             text-align: center;
             padding: 0.5rem;
        }
         .attendance-table th:nth-child(2), .attendance-table td:nth-child(2) { 
             text-align: left;
        }
        #roi-editor-modal .modal-lg {
            max-width: 95%;
        }
        #roi-image-container {
            max-height: 70vh;
            overflow: hidden;
        }
        #roi-image {
             max-width: 100%;
        }
        .cropper-view-box, .cropper-face {
             border-radius: .25rem;
        }
        #collect-progress-label {
            font-size: 0.9rem;
            font-weight: 500;
            display: block;
            margin-bottom: 0.3rem;
        }
        #training-loading-indicator span {
            font-size: 0.95rem;
        }
        #attendance-log-table-container .table-responsive {
            max-height: 75vh;
        }
        /* CSS cho contractor/field display */
        .selected-contractor-display,
        .selected-field-display {
            min-height: 38px; /* Bằng chiều cao input mặc định */
            display: flex;
            align-items: center;
            background-color: #f8f9fa; /* Màu nền nhẹ */
            padding: .375rem .75rem;
            border: 1px solid #ced4da; /* Viền giống input */
            border-radius: .25rem;
            margin-bottom: 0.5rem; /* Khoảng cách với nút chọn */
        }
        .selected-field-display {
             border-left: 3px solid #17a2b8; /* Thêm viền màu */
             padding-left: 10px;
             margin-bottom: 0; /* Không cần margin bottom cho field */
        }
        /* Nút chọn nhà thầu */
        .choose-contractor-btn {
             width: 100%;
             margin-bottom: 1rem;
        }
        /* Thêm style cho hàng action mới */
        .global-actions button {
            margin: 0 10px; /* Thêm khoảng cách ngang giữa các nút */
        }
    </style>
{% endblock %}

{% block content %}
<!-- Hàng mới cho các nút actions toàn cục -->
<div class="row mb-4">
    <div class="col-12 text-center global-actions">
        <button type="button" id="ajax-train-button" class="btn btn-info btn-lg">
            <i class="fas fa-brain mr-2"></i>Huấn luyện Model
        </button>
        <button type="button" id="view-dataset-btn" class="btn btn-secondary btn-lg">
            <i class="fas fa-images mr-2"></i>Xem Dataset
        </button>
    </div>
</div>
<!-- Kết thúc hàng mới -->

<div class="container-fluid mt-4" data-is-processing="{% if is_processing %}true{% else %}false{% endif %}"> 
    <div class="row">
        <!-- Cột Video Stream -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm video-card"> 
                 <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center py-2">
                    <h5 class="mb-0 mr-auto">Video Stream</h5>
                     <button id="refresh-stream-btn" class="btn btn-light btn-sm mr-2" title="Làm mới Stream" {% if not is_processing %}disabled{% endif %}><i class="fas fa-sync-alt fa-xs"></i></button>
                     <form method="POST" style="display: inline;" id="stop-form">
                         {% csrf_token %}
                         <input type="hidden" name="action" value="stop">
                         <button type="button" id="stop-button" class="btn btn-danger btn-sm" {% if not is_processing %}disabled{% endif %}>
                             <i class="fas fa-stop"></i> Dừng
                         </button>
                     </form>
                </div>
                <div class="card-body">
                    <div class="video-container {% if is_processing %}is-streaming{% endif %}"> 
                        <img id="video-stream" 
                             src="{% if is_processing %}{% url 'video-feed' %}{% else %}{% static 'recognition/img/placeholder.png' %}{% endif %}" 
                             alt="Video Stream Area">
                        <div class="video-placeholder-text">
                             {% if not is_processing %}
                             Vui lòng chọn camera và bắt đầu xử lý.
                             {% endif %}
                         </div>
                     </div>
                </div>
             </div>
        </div>

        <!-- Cột Cấu hình -->
        <div class="col-lg-4">
            <!-- Card Cấu hình -->
            <div class="card shadow-sm mb-4">
                 <div class="card-header bg-primary text-white py-2">
                    <h5 class="mb-0">Cấu hình & Điều khiển</h5>
                </div>
                <div class="card-body config-form"> 
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show small p-2" role="alert">
                                {{ message }}
                                <button type="button" class="close p-2" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <form method="POST" id="process-form" novalidate>
                        {% csrf_token %}
                        <input type="hidden" name="action" value="start">

                        <!-- Camera -->
                            <div class="form-group">
                                {{ form.camera|as_crispy_field }}
                             <div class="mt-1">
                                 <a href="{% url 'add-camera' %}" class="btn btn-success btn-sm" title="Thêm Camera Mới"><i class="fas fa-plus fa-xs"></i> Thêm</a>
                                 <a href="#" id="configure-roi-link" class="btn btn-secondary btn-sm ml-1" title="Cấu hình ROI"><i class="fas fa-edit fa-xs"></i> ROI</a>
                            </div>
                        </div>
                        <hr>
                        <!-- Mode -->
                         <div class="form-group">
                             <!-- <label class="mb-1">Chế độ xử lý:</label> --> <!-- Bỏ label chung -->
                             <div id="div_id_mode"> <!-- Giữ ID này để JS tìm -->
                            {{ form.mode|as_crispy_field }}
                        </div>
                         </div>
                         <!-- Username (sẽ được di chuyển) -->
                         <div class="form-group {% if form.mode.value != 'collect' %}d-none{% endif %}" id="div_id_username">
                             {{ form.username|as_crispy_field }}
                             
                             <!-- Thêm trường Email (ẩn ban đầu) -->
                             <div id="email-field-group" style="display: none;"> 
                                 {{ form.email|as_crispy_field }}
                             </div>
                             
                             <!-- Thêm trường Role -->
                             {{ form.role|as_crispy_field }}
                             
                             <!-- Thêm trường Supervisor (ẩn ban đầu) -->
                             <div id="supervisor-field-group" style="display: none;"> 
                                 {{ form.supervisor|as_crispy_field }}
                             </div>
                             
                             <!-- Thêm trường nhà thầu và lĩnh vực (ẩn ban đầu) -->
                             <div id="contractor-field-group" style="display: none;">
                                 <div class="form-group">
                                     <label for="contractor_select">Nhà thầu</label>
                                     <div class="input-group">
                                         <div class="form-control selected-contractor-display">
                                             <em class="text-muted">Chưa chọn nhà thầu</em>
                                         </div>
                                         <div class="input-group-append">
                                             <button type="button" id="choose_contractor_btn" class="btn btn-primary" title="Chọn nhà thầu">
                                                 <i class="fas fa-building"></i> Chọn
                                             </button>
                                         </div>
                                     </div>
                                     {{ form.contractor|as_crispy_field }}
                                 </div>
                                 
                                 <div class="form-group">
                                     <label for="field_display">Lĩnh vực</label>
                                     <div class="form-control selected-field-display">
                                         <em class="text-muted">Chưa có lĩnh vực</em>
                                     </div>
                                     {{ form.field|as_crispy_field }}
                                 </div>
                             </div>
                             
                             <!-- Thêm trường Company -->
                             {{ form.company|as_crispy_field }}
                        </div>
                         <hr>
                         <!-- Nút Bắt đầu / Train -->
                         <div class="text-center control-buttons">
                             <button class="btn btn-primary" type="button" id="start-process-button" {% if is_processing %}disabled{% endif %}>
                                  <i class="fas fa-play"></i> Bắt đầu
                              </button>
                 </div>
                          <!-- Progress bar for Data Collection -->
                          <div id="collect-progress-container" class="mt-3" style="display: none;">
                              <label id="collect-progress-label">Đang thu thập cho: </label>
                              <div class="progress">
                                  <div id="collect-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                 </div>
                </div>
                          <!-- Loading indicator for Training -->
                          <div id="training-loading-indicator" class="text-center mt-2" style="display: none;">
                              <span class="text-muted"><i class="fas fa-spinner fa-spin"></i> Đang huấn luyện...</span>
                </div>
                      </form>
            </div>
        </div>
    </div>
</div>

<!-- ROI Editor Modal -->
<div class="modal fade" id="roi-editor-modal" tabindex="-1" role="dialog" aria-labelledby="roiModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="roiModalLabel">Chọn Vùng Quan Tâm (ROI)</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                 <p class="text-muted small">Kéo thả để vẽ vùng chữ nhật trên ảnh. Đảm bảo vùng chọn bao quanh khu vực bạn muốn theo dõi.</p>
                <div id="roi-image-container">
                    <img id="roi-image" src="" alt="ROI Frame">
                 </div>
                <div id="roi-loading-indicator" style="display: none; text-align: center; padding: 20px;">
                    <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                    <p>Đang tải frame...</p>
                </div>
                <div id="roi-error-message" class="alert alert-danger mt-2" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-info mr-auto" id="get-new-frame-btn">Lấy Frame Khác</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="cancel-roi-btn">Hủy</button>
                <button type="button" class="btn btn-primary" id="save-roi-btn">Lưu ROI</button>
            </div>
        </div>
    </div>
</div>

<!-- Dataset Viewer Modal -->
<div class="modal fade" id="dataset-viewer-modal" tabindex="-1" role="dialog" aria-labelledby="datasetViewerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="datasetViewerModalLabel">Xem Dataset Người dùng</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="dataset-username-select">Chọn Username:</label>
                    <select class="form-control" id="dataset-username-select">
                        <option value="">-- Chọn Username --</option>
                        <!-- Options sẽ được thêm bằng JavaScript -->
                    </select>
                </div>
                <hr>
                <div id="dataset-image-container" class="text-center" style="min-height: 150px;">
                    <!-- Ảnh sẽ được thêm bằng JavaScript -->
                     <p class="text-muted dataset-placeholder">Vui lòng chọn username để xem ảnh.</p>
                     <div class="spinner-border text-primary dataset-loading" role="status" style="display: none;">
                         <span class="sr-only">Đang tải ảnh...</span>
                     </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Quản lý Nhà thầu -->
<div class="modal fade" id="contractors-manager-modal" tabindex="-1" role="dialog" aria-labelledby="contractorsManagerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="contractorsManagerModalLabel">Quản lý Danh sách Nhà thầu và Lĩnh vực</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <p class="mb-0">Chức năng này cho phép bạn quản lý danh sách nhà thầu và lĩnh vực công việc. Nhấn vào <i class="fas fa-check"></i> <b>Chọn</b> để sử dụng thông tin.</p>
                </div>
                
                <!-- Form thêm mới nhà thầu và lĩnh vực -->
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">Thêm mới</h6>
                        <div class="form-row">
                            <div class="col-md-5 mb-2">
                                <input type="text" class="form-control" id="new-contractor-name" placeholder="Tên nhà thầu">
                            </div>
                            <div class="col-md-5 mb-2">
                                <input type="text" class="form-control" id="new-contractor-field" placeholder="Lĩnh vực công việc">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-success btn-block" id="add-contractor-btn">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tìm kiếm -->
                <div class="form-group">
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                        </div>
                        <input type="text" class="form-control" id="contractor-search" placeholder="Tìm kiếm...">
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped table-bordered" id="contractors-table">
                        <thead>
                            <tr>
                                <th>Tên nhà thầu</th>
                                <th>Lĩnh vực</th>
                                <th class="text-center">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Danh sách nhà thầu sẽ được thêm ở đây bằng JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Thêm modal thông báo lỗi kết nối camera ngay sau các modal hiện có -->
<!-- Connection Error Modal -->
<div class="modal fade" id="camera-connection-error-modal" tabindex="-1" role="dialog" aria-labelledby="cameraErrorModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="cameraErrorModalLabel">Lỗi kết nối</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                <p>Kết nối thất bại, vui lòng liên hệ quản trị viên</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extrajs %}
    <!-- ... Các script JS cần thiết giữ nguyên (jQuery, Popper, Bootstrap, Select2, Cropper, SweetAlert2, Toastify) ... -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src="{% static 'recognition/vendor/cropperjs/cropper.min.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>
        $(document).ready(function() {
            // --- Các Selectors cần giữ lại ---
            var cameraSelect = $('#id_camera');
            var usernameFieldGroup = $('#div_id_username'); // Div chứa các trường collect
            var emailFieldGroup = $('#email-field-group'); // Div con cho email
            var supervisorFieldGroup = $('#supervisor-field-group'); // Div con cho supervisor select
            var contractorFieldGroup = $('#contractor-field-group'); // Div con cho contractor/field
            var usernameInput = $('#id_username'); // Input username
            var roleRadios = $('input[name="role"]'); // Radio buttons cho Role
            var modeRadios = $('input[name="mode"]'); // Radio buttons cho Mode
            var companyInputGroup = $('#div_id_company'); // Group cho trường Company (Cần đảm bảo ID này tồn tại hoặc điều chỉnh selector)
            var chooseContractorBtn = $('#choose_contractor_btn');
            var contractorInput = $('#id_contractor'); // Input ẩn contractor
            var fieldInput = $('#id_field'); // Input ẩn field
            var selectedContractorDisplay = $('.selected-contractor-display');
            var selectedFieldDisplay = $('.selected-field-display');
            var processForm = $("#process-form");
            var startButton = $("#start-process-button");
            var stopButton = $("#stop-button");
            var stopForm = $("#stop-form");
            var videoStreamImg = $("#video-stream");
            var videoContainer = $(".video-container");
            var placeholderText = $(".video-placeholder-text");
            var placeholderSrc = "{% static 'recognition/img/placeholder.png' %}";
            var videoFeedUrl = "{% url 'video-feed' %}";
            var roiModal = $('#roi-editor-modal');
            var roiImage = $('#roi-image');
            var saveRoiButton = $('#save-roi-btn');
            var cancelRoiButton = $('#cancel-roi-btn');
            var cropper = null;
            var refreshStreamBtn = $('#refresh-stream-btn');
            var currentCameraIdForRoi = null;
            var trainButton = $('#ajax-train-button');
            var getNewFrameButton = $('#get-new-frame-btn');
            var roiLoadingIndicator = $('#roi-loading-indicator');
            var roiErrorMessage = $('#roi-error-message');
            var collectProgressContainer = $('#collect-progress-container');
            var collectProgressBar = $('#collect-progress-bar');
            var collectProgressLabel = $('#collect-progress-label');
            var trainingLoadingIndicator = $('#training-loading-indicator');
            var progressInterval = null;
            var viewDatasetBtn = $('#view-dataset-btn');
            var usernameSelect = $('#dataset-username-select');
            var imageContainer = $('#dataset-image-container');
            var datasetPlaceholder = imageContainer.find('.dataset-placeholder');
            var datasetLoading = imageContainer.find('.dataset-loading');
            var contractorManagerModal = $('#contractors-manager-modal');
            var configureRoiLink = $('#configure-roi-link'); // Selector cho nút ROI

            // *** KHÔI PHỤC: Hàm hiển thị/ẩn các trường theo mode và role ***
            function toggleConditionalFields() {

                var selectedMode = $('input[name="mode"]:checked').val();
                var selectedRole = $('input[name="role"]:checked').val();


                // Tìm div chứa Company bằng cách khác nếu #div_id_company không đúng
                // Ví dụ: Tìm div cha của input #id_company
                var companyFieldParentDiv = $('#id_company').closest('.form-group');
                if (!companyFieldParentDiv.length) { // Nếu không tìm thấy, thử cách khác nếu cần

                   companyFieldParentDiv = $('#div_id_company'); // Quay lại dùng ID nếu có
                }

                if (selectedMode === 'collect') {
                    usernameFieldGroup.removeClass('d-none').addClass('mode-collect'); // Hiển thị group chính
                    companyFieldParentDiv.show(); // Luôn hiển thị Company khi collect

                    // Hiển thị/ẩn các trường con dựa trên Role
                    emailFieldGroup.toggle(selectedRole === 'supervisor');
                    supervisorFieldGroup.toggle(selectedRole === 'worker');
                    contractorFieldGroup.toggle(selectedRole === 'worker');
                    // Luôn hiển thị Role radio buttons khi collect
                    $('#div_id_role').show();

                    // Di chuyển field Username nếu chưa được di chuyển (kiểm tra class)
                    if (!usernameFieldGroup.hasClass('moved-username-field')) {

                         try {
                             // Di chuyển #div_id_username vào trong #div_id_mode
                             var targetElement = $('#div_id_mode .form-check').last().parent();

                             usernameFieldGroup.insertAfter(targetElement);
                             usernameFieldGroup.addClass('moved-username-field');

                         } catch (e) {
                             console.error(e);
                         }
                     }

                } else { // Mode là recognize hoặc stream

                    usernameFieldGroup.addClass('d-none').removeClass('mode-collect'); // Ẩn group chính
                    companyFieldParentDiv.hide(); // Ẩn Company
                    emailFieldGroup.hide(); // Ẩn Email
                    supervisorFieldGroup.hide(); // Ẩn Supervisor
                    contractorFieldGroup.hide(); // Ẩn Contractor/Field
                    // Ẩn luôn cả Role radio buttons khi không phải collect
                    $('#div_id_role').hide();
                    console.log(`[Debug] Hiding fields complete. usernameFieldGroup classes: ${usernameFieldGroup.attr('class')}`); // Thêm log
                }
            }

            // *** KHÔI PHỤC: Gọi hàm lần đầu khi trang tải ***

            toggleConditionalFields();

            // *** KHÔI PHỤC: Gắn sự kiện change cho Mode và Role radios ***

            modeRadios.change(toggleConditionalFields);
            roleRadios.change(toggleConditionalFields);

            // --- Các hàm và logic xử lý form, video, train, dataset, contractor giữ nguyên ---
            // ... (Ví dụ: contractorInput.closest..., chooseContractorBtn.click, etc.) ...
            // --- Hàm xử lý nút Dừng (stopButton.click) ---
            stopButton.click(function() {

                 var button = $(this);
                 button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Dừng...');
                 // Gửi yêu cầu dừng qua AJAX (sử dụng form stop-form)
                 $.ajax({
                     url: "{% url 'home' %}", // Gửi đến cùng view xử lý
                     type: "POST",
                     data: stopForm.serialize(), // Dữ liệu từ form Dừng (action=stop)
                     dataType: "json",
                     success: function(response) {

                         if (response.status === 'success') {
                             // Reset giao diện về trạng thái ban đầu
                             // button.prop('disabled', true); // Không disable lại nút dừng khi thành công
                             startButton.prop('disabled', false).html('<i class="fas fa-play"></i> Bắt đầu'); // Enable nút Start
                             refreshStreamBtn.prop('disabled', true);
                             videoStreamImg.attr("src", placeholderSrc);
                             videoContainer.removeClass('is-streaming');
                             placeholderText.show();
                             $("body").data("is-processing", false);
                             collectProgressContainer.hide(); // Ẩn progress bar
                             trainingLoadingIndicator.hide(); // Ẩn loading train
                             if (progressInterval) clearInterval(progressInterval); // Dừng cập nhật progress

                         } else {
                             alert("Lỗi khi dừng xử lý: " + response.message);
                             // button.prop('disabled', false).html('<i class="fas fa-stop"></i> Dừng'); // Sẽ được xử lý ở complete
                         }
                     },
                     error: function(jqXHR, textStatus, errorThrown) {
                         console.error("[Stop AJAX Error] Status:", textStatus, "Error:", errorThrown);

                         // button.prop('disabled', false).html('<i class="fas fa-stop"></i> Dừng'); // Sẽ được xử lý ở complete
                     },
                     complete: function() {
                         // Luôn đảm bảo nút Dừng được kích hoạt lại và reset text sau khi request hoàn tất
                         // Chỉ disable nếu *đang không* trong trạng thái processing
                         var isProcessing = $("body").data("is-processing");
                         button.prop('disabled', !isProcessing).html('<i class="fas fa-stop"></i> Dừng');
                     }
                 });
             });

            // --- Hàm xử lý nút Huấn luyện (trainButton.click) ---
            trainButton.click(function() {

                 var button = $(this);

                 // Hiển thị hộp thoại xác nhận
                 Swal.fire({
                     title: 'Xác nhận huấn luyện?',
                     text: "Quá trình này có thể mất vài phút.",
                     icon: 'question',
                     showCancelButton: true,
                     confirmButtonColor: '#3085d6',
                     cancelButtonColor: '#d33',
                     confirmButtonText: 'Đồng ý',
                     cancelButtonText: 'Hủy bỏ'
                 }).then((result) => {
                     if (result.isConfirmed) {
                         // Vô hiệu hóa các nút
                         button.prop('disabled', true);
                         viewDatasetBtn.prop('disabled', true);
                         // trainingLoadingIndicator.show(); // Bỏ loading cũ

                         // Hiển thị SweetAlert loading
                         Swal.fire({
                             title: 'Đang huấn luyện...',
                             text: 'Vui lòng chờ.',
                             allowOutsideClick: false,
                             allowEscapeKey: false,
                             didOpen: () => {
                                 Swal.showLoading();
                             }
                         });

                         $.ajax({
                             url: "{% url 'ajax-train' %}", // URL cho AJAX training
                             type: "POST",
                             data: { 'csrfmiddlewaretoken': '{{ csrf_token }}' }, // Gửi CSRF token
                             dataType: "json",
                             success: function(response) {
                                 Swal.close(); // Đóng loading alert
                                 if (response.status === 'success') {
                                     Swal.fire('Thành công!', response.message, 'success');
                                 } else {
                                     Swal.fire('Lỗi!', response.message || 'Không xác định', 'error');
                                 }
                             },
                             error: function(jqXHR, textStatus, errorThrown) {
                                 Swal.close(); // Đóng loading alert
                                 console.error("Training AJAX Error:", textStatus, errorThrown);
                                 // Chi tiết hơn về lỗi
                                 var errorMessage = "Không thể gửi yêu cầu huấn luyện.";
                                 if (jqXHR.responseJSON && jqXHR.responseJSON.message) {
                                     errorMessage = jqXHR.responseJSON.message;
                                 } else if (jqXHR.responseText) {
                                     try {
                                         var errData = JSON.parse(jqXHR.responseText);
                                         if (errData && errData.message) errorMessage = errData.message;
                                     } catch(e) { /* Bỏ qua nếu không phải JSON */ }
                                 }
                                 Swal.fire('Lỗi Kết Nối!', errorMessage, 'error');
                             },
                             complete: function() {
                                 // Kích hoạt lại các nút dù thành công hay lỗi
                                 button.prop('disabled', false);
                                 viewDatasetBtn.prop('disabled', false);
                                 // trainingLoadingIndicator.hide(); // Bỏ loading cũ
                             }
                         });
                     }
                 });
             });

             // *** KHÔI PHỤC: Hàm lấy frame tĩnh cho ROI ***
             function fetchAndDisplayRoiFrame(cameraId) {
                 currentCameraIdForRoi = cameraId;
                 roiLoadingIndicator.show();
                 roiImage.hide();
                 roiErrorMessage.hide();
                 if (cropper) { cropper.destroy(); cropper = null; } // Hủy cropper cũ

                 $.ajax({
                     url: `/get_static_frame/${cameraId}/`, // Sử dụng URL đã định nghĩa
                     type: 'GET',
                     dataType: 'json', // Mong đợi JSON
                     timeout: 15000, // Thêm timeout 15 giây phòng trường hợp camera chậm
                     success: function(response) {
                         // *** THÊM LOG CHI TIẾT TRONG SUCCESS ***

                         roiLoadingIndicator.hide();
                         // *** THAY ĐỔI: Kiểm tra và sử dụng frame_base64 ***
                         if (response && response.status === 'success' && response.frame_base64) {

                             // Đặt src trực tiếp bằng Data URL
                             roiImage.attr('src', response.frame_base64);
                             roiImage.show();
                             // Có thể cần chút delay để trình duyệt render ảnh base64 lớn
                             setTimeout(initializeCropper, 150); // Đợi ảnh tải rồi khởi tạo Cropper
                         } else {
                             // Xử lý lỗi nếu không có base64 hoặc status không thành công
                             var errorMsg = (response && response.message) ? response.message : 'Phản hồi không hợp lệ hoặc không có dữ liệu ảnh Base64.';
                             console.error('[ROI Fetch Success] Error in response structure:', errorMsg, response);
                             roiErrorMessage.text(errorMsg).show();
                         }
                         // *** KẾT THÚC THAY ĐỔI ***
                     },
                     error: function(jqXHR, textStatus, errorThrown) {
                         // *** THÊM LOG CHI TIẾT TRONG ERROR ***
                         roiLoadingIndicator.hide();
                         console.error(`[ROI Fetch Error] Status: ${textStatus}, Error: ${errorThrown}`);
                         console.error('[ROI Fetch Error] jqXHR Object:', jqXHR);
                         var errorMsg = 'Lỗi kết nối khi lấy frame tĩnh.';
                         if (textStatus === 'timeout') {
                             errorMsg = 'Yêu cầu lấy frame tĩnh bị timeout.';
                         } else if (jqXHR.responseJSON && jqXHR.responseJSON.message) {
                             errorMsg = jqXHR.responseJSON.message; // Lấy lỗi từ backend nếu có
                         } else if (jqXHR.responseText) {
                            // Cố gắng hiển thị một phần response text nếu không phải JSON
                            console.error('[ROI Fetch Error] Response Text:', jqXHR.responseText.substring(0, 200)); 
                         }
                         roiErrorMessage.text(errorMsg).show();
                     }
                 });
             }

            // *** KHÔI PHỤC: Hàm khởi tạo Cropper.js ***
            function initializeCropper() {
                 if (cropper) { cropper.destroy(); } // Hủy instance cũ nếu có
                 var imageElement = document.getElementById('roi-image');
                 if (!imageElement || !imageElement.complete || imageElement.naturalWidth === 0) {
                      console.warn("Ảnh ROI chưa sẵn sàng, thử lại sau giây lát...");
                      setTimeout(initializeCropper, 200); // Thử lại sau 200ms
                      return;
                  }
                 cropper = new Cropper(imageElement, {
                     aspectRatio: NaN, // Cho phép tỷ lệ tự do
                     viewMode: 1, // Hạn chế vùng crop trong ảnh
                     dragMode: 'crop',
                     autoCropArea: 0.6, // Kích thước vùng crop ban đầu
                     movable: true,
                     zoomable: false, // Tắt zoom ảnh gốc
                     scalable: false, // Tắt scale ảnh gốc
                     cropBoxResizable: true,
                     toggleDragModeOnDblclick: false,
                 });
             }

            // *** KHÔI PHỤC: Sự kiện click cho nút Cấu hình ROI ***
            configureRoiLink.click(function(e) {
                 e.preventDefault();
                 var selectedCameraId = cameraSelect.val();
                 if (!selectedCameraId) {
                     alert('Vui lòng chọn camera trước.');
                     return;
                 }
                 roiModal.modal('show');
                 fetchAndDisplayRoiFrame(selectedCameraId);
             });

            // *** KHÔI PHỤC: Sự kiện click cho nút Lấy Frame Khác (trong modal ROI) ***
            getNewFrameButton.click(function() {
                 if (currentCameraIdForRoi) {
                     fetchAndDisplayRoiFrame(currentCameraIdForRoi);
                 }
             });

            // *** KHÔI PHỤC: Sự kiện click cho nút Lưu ROI ***
            saveRoiButton.click(function() {
                 if (!cropper || !currentCameraIdForRoi) return;

                 var roiData = cropper.getData(true); // Lấy dữ liệu ROI đã làm tròn
                 var naturalSize = cropper.getImageData(); // Lấy kích thước ảnh gốc mà Cropper đang dùng
                 var button = $(this);
                 button.prop('disabled', true).text('Đang lưu...');

                 // *** THAY ĐỔI: Gửi dữ liệu dạng JSON ***
                 var postData = {
                     'roi_x': roiData.x,
                     'roi_y': roiData.y,
                     'roi_width': roiData.width,
                     'roi_height': roiData.height,
                     // Gửi thêm kích thước ảnh gốc để backend tính toán tỉ lệ
                     'natural_width': naturalSize.naturalWidth,
                     'natural_height': naturalSize.naturalHeight
                 };

                 $.ajax({
                     url: `/save_roi/${currentCameraIdForRoi}/`, // URL để lưu ROI
                     type: 'POST',
                     // Đặt kiểu nội dung là JSON
                     contentType: 'application/json; charset=utf-8',
                     // Chuyển đổi object thành chuỗi JSON
                     data: JSON.stringify(postData),
                     // Gửi CSRF token qua header
                     headers: {
                         "X-CSRFToken": "{{ csrf_token }}"
                     },
                     dataType: 'json', // Mong đợi phản hồi JSON
                     success: function(response) {
                         button.prop('disabled', false).text('Lưu ROI');
                         if (response.status === 'success') {
                             roiModal.modal('hide');
                             Toastify({ text: "Đã lưu ROI thành công!", duration: 3000, gravity: "top", position: "right", backgroundColor: "#28a745" }).showToast();

                         } else {
                             alert('Lỗi khi lưu ROI: ' + response.message);
                             console.error(response.message);
                         }
                     },
                     error: function(jqXHR, textStatus, errorThrown) {
                         // *** THÊM LOG CHI TIẾT HƠN CHO LỖI LƯU ROI ***
                         button.prop('disabled', false).text('Lưu ROI');
                         console.error(`[Save ROI AJAX Error] Status: ${textStatus}, Error: ${errorThrown}`);
                         console.error('[Save ROI AJAX Error] jqXHR:', jqXHR);
                         var errorMsg = 'Lỗi kết nối khi lưu ROI.';
                         if (jqXHR.responseJSON && jqXHR.responseJSON.message) {
                             errorMsg = jqXHR.responseJSON.message;
                         } else if (jqXHR.responseText) {
                              try {
                                   var errData = JSON.parse(jqXHR.responseText);
                                   if (errData && errData.message) errorMsg = errData.message;
                              } catch(e) { /* Bỏ qua nếu không phải JSON */ }
                         }
                         alert(errorMsg);
                         // *** KẾT THÚC THÊM LOG ***
                     }
                 });
                 // *** KẾT THÚC THAY ĐỔI GỬI JSON ***
             });

            // --- Hàm cập nhật tiến trình Thu thập dữ liệu ---
            function updateCollectProgress() {
                console.log("[Progress] Đang kiểm tra tiến trình..."); // Mở log debug
                
                // Đếm số lần kiểm tra chưa tìm thấy tiến trình
                if (!window.progressCheckCounter) window.progressCheckCounter = 0;
                
                $.ajax({
                    url: "{% url 'get-collect-progress' %}", // URL để lấy tiến trình
                    type: "GET",
                    dataType: "json",
                    success: function(response) {
                        console.log("[Progress Response]", response); // Mở log debug
                        var isActive = false;
                        
                        // Kiểm tra xem response có đúng định dạng không
                        if (response && response.status === 'success') {
                            var progressData = response.progress || {};
                            var hasAnyProgressData = !$.isEmptyObject(progressData);
                            
                            // Lấy username hiện tại
                            var currentUsername = $('#id_username').val();
                            console.log("[Progress] Current username:", currentUsername);
                            
                            // Kiểm tra nếu có bất kỳ dữ liệu nào
                            if (hasAnyProgressData) {
                                // Đặt lại bộ đếm kiểm tra vì đã có dữ liệu
                                window.progressCheckCounter = 0;
                                
                                // Kiểm tra nếu có dữ liệu cho username hiện tại
                                if (currentUsername && progressData[currentUsername]) {
                                    var data = progressData[currentUsername];
                                    console.log("[Progress] Found data for current user:", data);
                                    
                                    // Hiển thị progress bar ngay cả khi chưa active
                                    collectProgressContainer.show();
                                    collectProgressLabel.text(`Đang thu thập cho: ${currentUsername}`);
                                    var percentage = (data.current / data.total) * 100;
                                    console.log(`[Progress] ${currentUsername}: ${data.current}/${data.total} (${percentage.toFixed(1)}%)`);
                                    collectProgressBar.css('width', percentage + '%').attr('aria-valuenow', percentage).text(Math.round(percentage) + '%');
                                    
                                    // Kiểm tra trạng thái active và completed
                                    if (data.active) {
                                        isActive = true;
                                        if (data.current >= data.total) {
                                            console.log(`[Progress] Thu thập có thể đã hoàn thành cho ${currentUsername}. Tiến trình đã đạt ${data.current}/${data.total}.`);
                                            collectProgressLabel.text(`Đã xong cho: ${currentUsername}`);
                                            // Vẫn giữ isActive = true để hiển thị thanh tiến trình thêm một lúc
                                        } 
                                    } else if (data.completed) {
                                        // Nếu đã hoàn thành, hiển thị message hoàn thành
                                        console.log(`[Progress] Tiến trình đã hoàn thành cho ${currentUsername}.`);
                                        collectProgressLabel.text(`Hoàn thành: ${currentUsername} (${data.current}/${data.total})`);
                                        
                                        // Hiển thị thêm một khoảng thời gian rồi ẩn đi
                                        if (!window.completedTimeout) {
                                            window.completedTimeout = setTimeout(function() {
                                                console.log("[Progress] Ẩn progress bar sau khi hiển thị hoàn thành.");
                                                collectProgressContainer.fadeOut();
                                                window.completedTimeout = null;
                                                
                                                clearInterval(progressInterval);
                                                progressInterval = null;
                                            }, 5000);
                                        }
                                        
                                        // Không đặt isActive = false để giữ hiển thị
                                        isActive = true;
                                        return;
                                    } else {
                                        // Nếu không active nhưng có tiến độ, vẫn hiển thị trong một thời gian
                                        if (data.current > 0) {
                                            console.log(`[Progress] Tiến trình không còn active cho ${currentUsername} nhưng đã có ${data.current}/${data.total} mẫu.`);
                                            collectProgressLabel.text(`Đã dừng: ${currentUsername} (${data.current}/${data.total})`);
                                        }
                                        if (!window.completedTimeout) {
                                            window.completedTimeout = setTimeout(function() {
                                                console.log("[Progress] Ẩn progress bar sau khi hiển thị tiến trình.");
                                                collectProgressContainer.fadeOut();
                                                window.completedTimeout = null;
                                                
                                                clearInterval(progressInterval);
                                                progressInterval = null;
                                            }, 5000);
                                        }
                                    }
                                }
                            }
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error("[Progress AJAX Error] Status:", textStatus, "Error:", errorThrown);
                        collectProgressContainer.hide();
                        trainingLoadingIndicator.hide();
                        collectProgressLabel.text("Không thể lấy tiến trình.");
                        collectProgressBar.css('width', '0%').attr('aria-valuenow', 0).text('0%');
                    }
                });
            }

            // --- Hàm xử lý click cho nút Bắt đầu ---
            startButton.click(function() {
                console.log("[Click] Nút Bắt đầu được click");
                var button = $(this);
                
                // Kiểm tra xem đã có tiến trình đang chạy chưa
                var isProcessing = $("body").data("is-processing");
                
                // --- Phần Validation ---
                if (!cameraSelect.val()) { alert("Vui lòng chọn camera."); return false; }
                var selectedMode = $('input[name="mode"]:checked').val();
                var username = $("#id_username").val();
                if (selectedMode === 'collect' && !username) { alert("Vui lòng nhập Username cho chế độ Thu thập."); return false; }
                var selectedRole = $('input[name="role"]:checked').val(); 
                if (selectedMode === 'collect' && !selectedRole) { alert("Vui lòng chọn Vai trò."); return false; } 
                if (selectedMode === 'collect' && selectedRole === 'worker') {
                    var selectedSupervisor = $('#id_supervisor').val(); 
                    if (!selectedSupervisor) { alert("Vui lòng chọn Supervisor cho Worker."); return false; }
                    var contractorValue = contractorInput.val(); // Lấy từ input ẩn
                    var fieldValue = fieldInput.val(); // Lấy từ input ẩn
                    if (!contractorValue) { alert("Vui lòng chọn Nhà thầu cho Worker."); return false; }
                    if (!fieldValue) { alert("Vui lòng nhập Lĩnh vực công việc cho Worker."); return false; }
                }
                if (selectedMode === 'collect' && selectedRole === 'supervisor') {
                    var emailValue = $('#id_email').val(); 
                    if (!emailValue) { alert("Vui lòng nhập Email cho Supervisor."); return false; }
                }
                // --- Kết thúc Validation ---

                button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Bắt đầu...');
                
                // Nếu đã có tiến trình đang chạy, dừng tiến trình đó trước
                if (isProcessing) {
                    console.log("[Process] Có tiến trình đang chạy, dừng tiến trình hiện tại trước khi bắt đầu mới");
                    
                    Swal.fire({
                        title: 'Đang dừng tiến trình hiện tại...',
                        text: 'Vui lòng chờ trong giây lát.',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        showConfirmButton: false,
                        willOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    // Gửi yêu cầu dừng tiến trình hiện tại
                    $.ajax({
                        url: "{% url 'home' %}",
                        type: "POST",
                        data: stopForm.serialize(), // Dữ liệu từ form Dừng (action=stop)
                        dataType: "json",
                        success: function(stopResponse) {
                            console.log("[Stop Response]", stopResponse);
                            
                            if (stopResponse.status === 'success') {
                                // Sau khi dừng thành công, bắt đầu tiến trình mới
                                Swal.close();
                                startProcess(button);
                            } else {
                                // Nếu không dừng được tiến trình
                                Swal.fire({
                                    title: 'Lỗi',
                                    text: 'Không thể dừng tiến trình hiện tại: ' + (stopResponse.message || 'Không xác định'),
                                    icon: 'error',
                                    confirmButtonText: 'Đóng'
                                });
                                button.prop('disabled', false).html('<i class="fas fa-play"></i> Bắt đầu');
                            }
                        },
                        error: function(jqXHR, textStatus, errorThrown) {
                            console.error("[Stop AJAX Error]", textStatus, errorThrown);
                            Swal.fire({
                                title: 'Lỗi',
                                text: 'Không thể dừng tiến trình hiện tại do lỗi kết nối.',
                                icon: 'error',
                                confirmButtonText: 'Đóng'
                            });
                            button.prop('disabled', false).html('<i class="fas fa-play"></i> Bắt đầu');
                        }
                    });
                } else {
                    // Nếu không có tiến trình đang chạy, bắt đầu tiến trình mới ngay
                    startProcess(button);
                }
            });
            
            // Hàm xử lý bắt đầu tiến trình mới
            function startProcess(button) {
                var formData = processForm.serialize(); 
                if (formData.indexOf('action=start') === -1) {
                    formData += '&action=start'; 
                }

                console.log("[Start AJAX] Sending form data:", formData);

                $.ajax({
                    url: "{% url 'home' %}", 
                    type: "POST",
                    data: formData,
                    dataType: "json",
                    success: function(response) {
                        console.log("[Start AJAX Success] Response:", response);
                        if (response.status === 'success') {
                            stopButton.prop('disabled', false);
                            refreshStreamBtn.prop('disabled', false);
                            placeholderText.hide();
                            videoContainer.addClass('is-streaming');
                            videoStreamImg.attr("src", videoFeedUrl + "?ts=" + new Date().getTime());
                            $("body").data("is-processing", true);
                            if ($('input[name="mode"]:checked').val() === 'collect') {
                                console.log("[Progress] Bắt đầu cập nhật tiến trình sau khi start thành công.");
                                
                                // Dừng interval cũ nếu có
                                if (progressInterval) {
                                    console.log("[Progress] Dừng interval cũ và tạo interval mới.");
                                    clearInterval(progressInterval);
                                    progressInterval = null;
                                }
                                
                                // Reset progress bar ngay lúc này
                                collectProgressBar.css('width', '0%').attr('aria-valuenow', 0).text('0%');
                                collectProgressContainer.show();
                                
                                // Hiển thị username
                                var collectionUsername = $('#id_username').val();
                                collectProgressLabel.text('Đang thu thập cho: ' + collectionUsername);
                                console.log("[Progress] Hiển thị progress bar cho: " + collectionUsername);
                                
                                // Bắt đầu interval mới sau một khoảng thời gian ngắn để cho backend có thời gian khởi tạo
                                setTimeout(function() {
                                    console.log("[Progress] Bắt đầu interval cập nhật tiến trình.");
                                    // Gọi ngay lần đầu
                                    updateCollectProgress();
                                    // Sau đó thiết lập interval
                                    progressInterval = setInterval(updateCollectProgress, 1000);
                                }, 1000);
                            }
                            if(response.message) { console.log("Backend message:", response.message); }
                            // Không disable nút start nữa nếu thành công, để user có thể bấm lại nếu muốn (ví dụ đổi camera)
                            button.prop('disabled', false).html('<i class="fas fa-play"></i> Bắt đầu');
                        } else {
                            // Trường hợp status không phải 'success'
                            Swal.fire({
                                title: 'Lỗi',
                                text: response.message || 'Không xác định',
                                icon: 'error',
                                confirmButtonText: 'Đóng'
                            });
                            button.prop('disabled', false).html('<i class="fas fa-play"></i> Bắt đầu');
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error("[Start AJAX Error] Status:", textStatus, "Error:", errorThrown, jqXHR.responseText);
                        
                        // Giải mã response JSON nếu có
                        var errorMessage = "Lỗi kết nối hoặc lỗi server khi gửi yêu cầu bắt đầu.";
                        var showConnectionErrorModal = false;
                        
                        try {
                            if (jqXHR.responseText) {
                                var responseObj = JSON.parse(jqXHR.responseText);
                                if (responseObj && responseObj.message) {
                                    errorMessage = responseObj.message;
                                    // Kiểm tra nếu là lỗi kết nối camera
                                    if (responseObj.message.includes("Không thể mở nguồn video") || 
                                        responseObj.message.includes("connection failed") ||
                                        responseObj.message.includes("camera") ||
                                        responseObj.message.includes("video source") ||
                                        responseObj.message.includes("404 Not Found") || // Bắt lỗi RTSP
                                        responseObj.message.includes("rtsp") || // Bắt lỗi RTSP
                                        responseObj.message.includes("method DESCRIBE failed")) { // Bắt lỗi RTSP
                                        showConnectionErrorModal = true;
                                    }
                                }
                            }
                        } catch (e) {
                            console.error("Error parsing response:", e);
                        }
                        
                        if (showConnectionErrorModal) {
                            // Hiển thị modal thông báo lỗi kết nối camera
                            $('#camera-connection-error-modal').modal('show');
                        } else {
                            // Sử dụng SweetAlert2 cho các lỗi khác
                            Swal.fire({
                                title: 'Lỗi',
                                text: errorMessage,
                                icon: 'error',
                                confirmButtonText: 'Đóng'
                            });
                        }
                        
                        button.prop('disabled', false).html('<i class="fas fa-play"></i> Bắt đầu');
                    }
                });
            }

            // --- Các hàm xử lý Dataset Viewer và Contractor Manager giữ nguyên ---
            // ... (viewDatasetBtn.click, usernameSelect.change, contractor manager functions, etc.) ...
            // *** THÊM LẠI CODE CHO DATASET VIEWER ***
            var datasetModal = $('#dataset-viewer-modal'); // Thêm selector

            // Mở modal xem dataset
            viewDatasetBtn.click(function() {
                // Reset select và container ảnh
                usernameSelect.empty().append('<option value="">-- Đang tải... --</option>');
                imageContainer.html('<p class="text-muted dataset-placeholder">Vui lòng chọn username để xem ảnh.</p>');
                datasetLoading.hide();
                datasetPlaceholder.show();
                datasetModal.modal('show');

                // Lấy danh sách username
                $.ajax({
                    url: "{% url 'get-dataset-usernames' %}",
                    type: "GET",
                    dataType: "json",
                    success: function(response) {
                        usernameSelect.empty().append('<option value="">-- Chọn Username --</option>');
                        if (response.status === 'success' && response.usernames.length > 0) {
                            response.usernames.forEach(function(username) {
                                usernameSelect.append(`<option value="${escapeHtml(username)}">${escapeHtml(username)}</option>`);
                            });
                        } else {
                            usernameSelect.append('<option value="" disabled>Không có dataset</option>');
                        }
                    },
                    error: function() {
                        usernameSelect.empty().append('<option value="" disabled>Lỗi tải danh sách</option>');
                        Swal.fire('Lỗi', 'Không thể tải danh sách username.', 'error');
                    }
                });
            });

            // Thay đổi username trong select
            usernameSelect.change(function() {
                var selectedUsername = $(this).val();
                imageContainer.empty(); // Xóa ảnh cũ
                if (!selectedUsername) {
                    datasetPlaceholder.show();
                    datasetLoading.hide();
                    return;
                }

                datasetPlaceholder.hide();
                datasetLoading.show();

                // Lấy ảnh ngẫu nhiên
                $.ajax({
                    url: `/get_random_images/${selectedUsername}/`,
                    type: "GET",
                    dataType: "json",
                    success: function(response) {
                        datasetLoading.hide();
                        // *** THAY ĐỔI: Kiểm tra key 'images' và thêm tiền tố Data URL ***
                        if (response.status === 'success' && Array.isArray(response.images) && response.images.length > 0) {
                            response.images.forEach(function(base64Image) {
                                // Thêm tiền tố để tạo Data URL hợp lệ (giả sử là JPEG)
                                var dataUrl = `data:image/jpeg;base64,${base64Image}`;
                                imageContainer.append(`
                                    <img src="${dataUrl}" alt="${escapeHtml(selectedUsername)}" class="img-thumbnail m-1" style="max-width: 120px; max-height: 120px; object-fit: cover;">
                                `);
                            });
                        } else {
                            // Xử lý khi không có ảnh hoặc lỗi
                            imageContainer.html('<p class="text-danger">Không tìm thấy ảnh hoặc có lỗi.</p>');
                        }
                    },
                    error: function() {
                        datasetLoading.hide();
                        imageContainer.html('<p class="text-danger">Lỗi khi tải ảnh.</p>');
                    }
                });
            });
             // *** KẾT THÚC THÊM CODE DATASET VIEWER ***

            // --- Xử lý lỗi tải ảnh video stream ---
            videoStreamImg.on('error', function() {
                console.warn("Lỗi tải video stream. Đặt lại thành placeholder.");
                $(this).attr('src', placeholderSrc);
                videoContainer.removeClass('is-streaming');
                placeholderText.show();
                $("body").data("is-processing", false); // Cập nhật trạng thái
                stopButton.prop('disabled', true); // Disable nút Dừng
                refreshStreamBtn.prop('disabled', true); // Disable nút Refresh
                startButton.prop('disabled', false).html('<i class="fas fa-play"></i> Bắt đầu'); // Enable nút Start
                if (progressInterval) clearInterval(progressInterval); // Dừng progress nếu có
                collectProgressContainer.hide();
                
                // Hiển thị modal thông báo lỗi kết nối camera
                $('#camera-connection-error-modal').modal('show');
            });

            // --- Xử lý nút Refresh Stream ---
             refreshStreamBtn.click(function() {
                 if ($("body").data("is-processing")) {
                     console.log("Refreshing video stream...");
                     videoStreamImg.attr("src", videoFeedUrl + "?ts=" + new Date().getTime()); // Thêm timestamp để force reload
                 }
             });

            // =========================================== //
            // === JavaScript Quản lý Nhà thầu (Contractor) === //
            // =========================================== //

            function escapeHtml(unsafe) {
                 if (typeof unsafe !== 'string') return unsafe;
                 return unsafe
                      .replace(/&/g, "&amp;")
                      .replace(/</g, "&lt;")
                      .replace(/>/g, "&gt;")
                      .replace(/"/g, "&quot;")
                      .replace(/'/g, "&#039;");
             }

            function saveContractorsToStorage() {
                var contractors = [];
                $('#contractors-table tbody tr').each(function() {
                    if ($(this).find('.save-edit-btn').length === 0) {
                        contractors.push({
                            name: $(this).data('contractor'),
                            field: $(this).data('field') || ''
                        });
                    }
                });
                localStorage.setItem('contractors_list', JSON.stringify(contractors));
                // Không cần gọi saveContractorsToFirebase ở đây nếu không muốn đồng bộ mỗi lần lưu
            }

            // // Hàm đồng bộ lên Firebase (TÙY CHỌN - có thể bỏ nếu không cần ở trang này)
            // function saveContractorsToFirebase(contractors) {
            //     const csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
            //     $.ajax({
            //         url: "{% url 'save-contractor-to-firebase' %}",
            //         type: "POST",
            //         data: JSON.stringify({ contractors: contractors }),
            //         contentType: "application/json",
            //         headers: { "X-CSRFToken": csrfToken },
            //         success: function(response) {
            //             console.log("[Firebase] Đồng bộ nhà thầu thành công:", response);
            //         },
            //         error: function(jqXHR, textStatus, errorThrown) {
            //             console.error("[Firebase] Lỗi khi đồng bộ nhà thầu:", textStatus, errorThrown);
            //         }
            //     });
            // }

            function loadContractorsFromLocalStorage() {
                var contractorsJson = localStorage.getItem('contractors_list');
                var tableBody = $('#contractors-table tbody');
                tableBody.empty();
                if (contractorsJson) {
                    try {
                        var contractors = JSON.parse(contractorsJson);
                        contractors.forEach(function(contractor) {
                            addContractorRow(tableBody, contractor.name, contractor.field);
                        });
                    } catch (e) {
                        console.error("Lỗi khi tải danh sách nhà thầu:", e);
                        localStorage.removeItem('contractors_list');
                    }
                }
            }

            function addContractorRow(tableBody, name, field) {
                var fieldDisplay = field ? field : '<em class="text-muted">Chưa có</em>';
                var newRow = `
                    <tr data-contractor="${escapeHtml(name)}" data-field="${escapeHtml(field || '')}">
                        <td class="contractor-name-cell">${escapeHtml(name)}</td>
                        <td class="contractor-field-cell">${fieldDisplay}</td>
                        <td class="text-center action-buttons">
                            <button class="btn btn-sm btn-primary select-contractor-btn" title="Chọn nhà thầu này">
                                <i class="fas fa-check"></i> Chọn
                            </button>
                            <button class="btn btn-sm btn-secondary edit-contractor-btn" title="Sửa thông tin">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-contractor-btn" title="Xóa nhà thầu">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tableBody.append(newRow);
            }

            // Mở modal quản lý nhà thầu
            chooseContractorBtn.click(function() {
                loadContractorsFromLocalStorage(); // Tải danh sách nhà thầu vào bảng modal
                contractorManagerModal.modal('show');
            });

            // Tìm kiếm nhà thầu trong bảng
            $('#contractor-search').on('keyup', function() {
                var value = $(this).val().toLowerCase();
                $('#contractors-table tbody tr').filter(function() {
                    if ($(this).find('input').length > 0) {
                        return true;
                    }
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
                });
            });

            // Thêm nhà thầu mới vào bảng
            $('#add-contractor-btn').click(function() {
                var contractorNameInput = $('#new-contractor-name');
                var fieldValueInput = $('#new-contractor-field');
                var contractorName = contractorNameInput.val().trim();
                var fieldValue = fieldValueInput.val().trim();

                if (!contractorName) {
                    Swal.fire('Thiếu thông tin', 'Vui lòng nhập tên nhà thầu!', 'warning');
                    contractorNameInput.focus();
                    return;
                }

                var isDuplicate = false;
                $('#contractors-table tbody tr').each(function() {
                    if ($(this).data('contractor') === contractorName) {
                        isDuplicate = true;
                        return false;
                    }
                });

                if (isDuplicate) {
                     Swal.fire('Trùng lặp', 'Nhà thầu này đã tồn tại!', 'warning');
                     return;
                }

                addContractorRow($('#contractors-table tbody'), contractorName, fieldValue);
                contractorNameInput.val('');
                fieldValueInput.val('');
                saveContractorsToStorage();
            });

            // Chọn nhà thầu từ modal quản lý
            $(document).on('click', '.select-contractor-btn', function() {
                var row = $(this).closest('tr');
                var contractorName = row.data('contractor');
                var fieldValue = row.data('field') || ''; // Lấy field

                // Cập nhật input ẩn trong form chính
                contractorInput.val(contractorName);
                fieldInput.val(fieldValue);

                // Cập nhật hiển thị trên form chính
                selectedContractorDisplay.html(`<strong>${escapeHtml(contractorName)}</strong>`);
                selectedFieldDisplay.html(fieldValue ? `<strong>${escapeHtml(fieldValue)}</strong>` : '<em class="text-muted">Chưa có lĩnh vực</em>');

                // Đóng modal quản lý
                contractorManagerModal.modal('hide');
            });

            // Sửa nhà thầu
            $(document).on('click', '.edit-contractor-btn', function() {
                var row = $(this).closest('tr');
                if (row.find('.save-edit-btn').length > 0) return;
                var contractorName = row.data('contractor');
                var fieldValue = row.data('field') || '';
                row.data('original-html', row.html());
                row.html(`
                    <td><input type="text" class="form-control form-control-sm edit-contractor-name" value="${escapeHtml(contractorName)}"></td>
                    <td><input type="text" class="form-control form-control-sm edit-contractor-field" value="${escapeHtml(fieldValue)}"></td>
                    <td class="text-center action-buttons">
                        <button class="btn btn-sm btn-success save-edit-btn" title="Lưu"><i class="fas fa-check"></i></button>
                        <button class="btn btn-sm btn-secondary cancel-edit-btn" title="Hủy"><i class="fas fa-times"></i></button>
                    </td>
                `);
                row.find('.edit-contractor-name').focus();
            });

            // Lưu chỉnh sửa nhà thầu
            $(document).on('click', '.save-edit-btn', function() {
                var row = $(this).closest('tr');
                var oldName = row.data('contractor');
                var newNameInput = row.find('.edit-contractor-name');
                var newFieldInput = row.find('.edit-contractor-field');
                var newName = newNameInput.val().trim();
                var newField = newFieldInput.val().trim();

                if (!newName) {
                    Swal.fire('Thiếu thông tin', 'Tên nhà thầu không được để trống!', 'warning');
                    newNameInput.focus();
                    return;
                }

                if (oldName !== newName) {
                    var isDuplicate = false;
                    $('#contractors-table tbody tr').not(row).each(function() {
                        if ($(this).data('contractor') === newName) {
                            isDuplicate = true;
                            return false;
                        }
                    });
                    if (isDuplicate) {
                        Swal.fire('Trùng lặp', 'Nhà thầu này đã tồn tại!', 'warning');
                        return;
                    }
                }

                row.data('contractor', newName);
                row.data('field', newField);

                var fieldDisplay = newField ? escapeHtml(newField) : '<em class="text-muted">Chưa có</em>';
                row.html(`
                    <td class="contractor-name-cell">${escapeHtml(newName)}</td>
                    <td class="contractor-field-cell">${fieldDisplay}</td>
                    <td class="text-center action-buttons">
                        <button class="btn btn-sm btn-primary select-contractor-btn" title="Chọn"><i class="fas fa-check"></i> Chọn</button>
                        <button class="btn btn-sm btn-secondary edit-contractor-btn" title="Sửa"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger delete-contractor-btn" title="Xóa"><i class="fas fa-trash"></i></button>
                    </td>
                `);

                // Cập nhật lại form chính nếu nhà thầu đang được chọn bị sửa tên
                if (contractorInput.val() === oldName) {
                    contractorInput.val(newName);
                    fieldInput.val(newField);
                    selectedContractorDisplay.html(`<strong>${escapeHtml(newName)}</strong>`);
                    selectedFieldDisplay.html(newField ? `<strong>${escapeHtml(newField)}</strong>` : '<em class="text-muted">Chưa có lĩnh vực</em>');
                }
                saveContractorsToStorage();
            });

            // Hủy chỉnh sửa nhà thầu
            $(document).on('click', '.cancel-edit-btn', function() {
                var row = $(this).closest('tr');
                var originalHtml = row.data('original-html');
                if (originalHtml) {
                    row.html(originalHtml);
                } else {
                    // Fallback
                    var contractorName = row.data('contractor');
                    var fieldValue = row.data('field') || '';
                    var fieldDisplay = fieldValue ? escapeHtml(fieldValue) : '<em class="text-muted">Chưa có</em>';
                    row.html(`
                        <td class="contractor-name-cell">${escapeHtml(contractorName)}</td>
                        <td class="contractor-field-cell">${fieldDisplay}</td>
                         <td class="text-center action-buttons">
                             <button class="btn btn-sm btn-primary select-contractor-btn" title="Chọn"><i class="fas fa-check"></i> Chọn</button>
                             <button class="btn btn-sm btn-secondary edit-contractor-btn" title="Sửa"><i class="fas fa-edit"></i></button>
                             <button class="btn btn-sm btn-danger delete-contractor-btn" title="Xóa"><i class="fas fa-trash"></i></button>
                         </td>
                    `);
                }
            });

            // Xóa nhà thầu
            $(document).on('click', '.delete-contractor-btn', function() {
                var row = $(this).closest('tr');
                var contractorName = row.data('contractor');

                Swal.fire({
                    title: 'Xác nhận xóa?',
                    html: `Bạn có chắc muốn xóa nhà thầu <strong>${escapeHtml(contractorName)}</strong>?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Xóa',
                    cancelButtonText: 'Hủy bỏ'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Cập nhật form chính nếu nhà thầu đang được chọn bị xóa
                        if (contractorInput.val() === contractorName) {
                            contractorInput.val('');
                            fieldInput.val('');
                            selectedContractorDisplay.html('<em class="text-muted">Chưa chọn nhà thầu</em>');
                            selectedFieldDisplay.html('<em class="text-muted">Chưa có lĩnh vực</em>');
                        }
                        row.remove();
                        saveContractorsToStorage();
                        Swal.fire('Đã xóa!', `Nhà thầu ${escapeHtml(contractorName)} đã được xóa.`, 'success');
                    }
                });
            });
        }); // End $(document).ready()
    </script>
{% endblock extrajs %}