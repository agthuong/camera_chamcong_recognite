{% load static %}
{% load crispy_forms_tags %}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Xử lý Video ROI</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        body {
            padding-top: 2rem;
            padding-bottom: 2rem;
            background-color: #f8f9fa; /* Light gray background */
        }
        .card {
            margin-top: 2rem;
        }
        .roi-status {
            margin-bottom: 1rem;
            padding: 0.75rem 1.25rem;
            border: 1px solid transparent;
            border-radius: 0.25rem;
        }
        .roi-status-selected {
            color: #0f5132;
            background-color: #d1e7dd;
            border-color: #badbcc;
        }
        .roi-status-not-selected {
            color: #664d03;
            background-color: #fff3cd;
            border-color: #ffecb5;
        }
        .camera-section .form-group {
            display: flex;
            align-items: flex-start; /* Align items to the top */
            gap: 10px; /* Add some space between elements */
        }
        /* Allow crispy form group for camera to take up space */
        .camera-section .form-group > div {
             flex-grow: 1;
        }
        /* Adjust button size/margin if needed */
        .camera-section .btn-sm {
             margin-top: 5px; /* Add margin if needed */
        }
        .table-responsive {
            margin-top: 2rem;
        }
        .img-thumbnail {
            max-width: 100px;
            max-height: 100px;
        }
        .video-container {
            position: relative;
            width: 100%;
            /* padding-bottom: 56.25%; /* 16:9 aspect ratio */
            background-color: #000;
            margin-bottom: 1rem;
        }
        .video-container img {
            width: 100%;
            height: auto;
            display: block;
        }
        .control-buttons button {
            margin-right: 5px;
        }
    </style>
</head>
<body>

<div class="container-fluid mt-4"> <!-- Sử dụng container-fluid để rộng hơn -->
    <div class="row">
        <!-- Cột Video Stream và Controls (rộng hơn) -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm">
                 <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Video Stream</h4>
                     <!-- Nút Stop được đặt ở header -->
                     <form method="POST" style="display: inline;">
                         {% csrf_token %}
                         <input type="hidden" name="action" value="stop">
                         <button type="submit" class="btn btn-danger btn-sm" {% if not is_processing %}disabled{% endif %}>
                             <i class="fas fa-stop"></i> Dừng Xử lý
                         </button>
                     </form>
                </div>
                <div class="card-body">
                    <div class="video-container">
                        <!-- Thẻ img để hiển thị video stream -->
                        {% if is_processing %}
                             <img id="video-stream" src="{% url 'video-feed' %}" alt="Video Stream">
                        {% else %}
                             <img id="video-stream" src="{% static 'recognition/img/placeholder.png' %}" alt="Video Stream Stopped"> <!-- Ảnh placeholder -->
                        {% endif %}
                    </div>
                </div>
             </div>
        </div>

        <!-- Cột Cấu hình và Log/Bảng Chấm công (hẹp hơn) -->
        <div class="col-lg-4">
            <!-- Card Cấu hình -->
            <div class="card shadow-sm mb-4">
                 <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Cấu hình & Bắt đầu</h4>
                </div>
                <div class="card-body">
                     {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <form method="POST" id="process-form" novalidate>
                         {% csrf_token %}
                        <input type="hidden" name="action" value="start"> <!-- Action mặc định là start -->

                        <!-- Phần chọn Camera và nút Add -->
                         <div class="camera-section mb-3">
                             <div class="form-group mb-0">
                                {{ form.camera|as_crispy_field }}
                                <a href="{% url 'add-camera' %}" class="btn btn-success btn-sm mt-4" title="Thêm Camera Mới">
                                    <i class="fas fa-plus"></i>
                                </a>
                            </div>
                            <small class="form-text text-muted mt-0 mb-2">
                                ROI sẽ được lấy tự động. <a href="#" id="configure-roi-link">Cấu hình ROI?</a>
                            </small>
                        </div>

                        <!-- Chế độ xử lý -->
                         <div class="form-group">
                            {{ form.mode|as_crispy_field }}
                        </div>
                         <div class="form-group" id="username-field-group">
                             {{ form.username|as_crispy_field }}
                        </div>

                        <!-- Nút Bắt đầu -->
                        <div class="form-group mt-3 text-center control-buttons">
                            <button class="btn btn-primary" type="submit" {% if is_processing %}disabled{% endif %}>
                                 <i class="fas fa-play"></i> Bắt đầu Xử lý
                             </button>
                         </div>
                     </form>
                     <hr>
                     <div class="text-center">
                         <a href="{% url 'train' %}" id="train-button" class="btn btn-info btn-sm">Huấn luyện Model</a>
                     </div>
                 </div>
             </div>

            <!-- Card Bảng Chấm Công -->
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">Chấm công gần đây</h4>
                </div>
                <div class="card-body">
                    <!-- Form tìm kiếm (có thể giữ hoặc bỏ) -->
                     <form method="get" class="mb-3">
                         <div class="input-group input-group-sm">
                             <input type="text" class="form-control" name="search" placeholder="Tìm tên..." value="{{ search_query }}">
                             <div class="input-group-append">
                                 <button type="submit" class="btn btn-secondary">Tìm</button>
                             </div>
                         </div>
                    </form>
                    <!-- Bảng chấm công -->
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;"> <!-- Giới hạn chiều cao và scroll -->
                        <table class="table table-sm table-striped table-hover">
                             <thead class="thead-light sticky-top"> <!-- Header cố định khi scroll -->
                                <tr>
                                    <th>Ngày</th>
                                    <th>Người dùng</th>
                                    <th>In</th>
                                    <th>Out</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in records %}
                                <tr>
                                     <td>{{ record.date|date:"d/m" }}</td>
                                    <td>{{ record.user.get_full_name|default:record.user.username|truncatechars:15 }}</td>
                                    <td>{{ record.check_in|date:"H:i"|default:"-" }}</td>
                                    <td>{{ record.check_out|date:"H:i"|default:"-" }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted">Chưa có dữ liệu</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                 </div>
             </div>
        </div>
    </div>
</div>

<!-- Optional JavaScript -->
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

<script>
    $(document).ready(function() {
        var cameraSelect = $('#id_camera');
        var modeSelect = $('#id_mode');
        var usernameFieldGroup = $('#username-field-group'); // Div chứa trường username
        var processForm = $("#process-form");
        var startButton = processForm.find("button[type='submit']");
        var stopButton = $("form button:contains('Dừng Xử lý')"); // Tìm nút Stop
        var videoStreamImg = $("#video-stream");
        var placeholderSrc = "{% static 'recognition/img/placeholder.png' %}"; // Cache placeholder src
        var videoFeedUrl = "{% url 'video-feed' %}";

        // Ẩn/hiện trường username dựa vào mode
        function toggleUsernameField() {
            if (modeSelect.val() === 'collect') {
                usernameFieldGroup.show();
            } else {
                usernameFieldGroup.hide();
            }
        }
        toggleUsernameField(); // Chạy lần đầu
        modeSelect.change(toggleUsernameField); // Chạy khi mode thay đổi

        // Đóng alert
        $('.alert .close').on('click', function(e) {
            $(this).parent().alert('close');
        });

        // Cảnh báo nút Train
        $("#train-button").click(function(e){
            if (!confirm("Bắt đầu quá trình huấn luyện? Việc này có thể mất vài phút và không thể dừng.")) {
                e.preventDefault(); // Ngăn chặn nếu người dùng hủy
            }
        });

        // --- Xử lý link Cấu hình ROI ---
        $("#configure-roi-link").click(function(e){
            e.preventDefault(); // Ngăn link chuyển trang
            var selectedCameraId = cameraSelect.val();
            if (!selectedCameraId) {
                alert("Vui lòng chọn một camera trước khi cấu hình ROI.");
                return;
            }
            var selectUrl = `/select_roi/${selectedCameraId}/`;
            alert("Mở cửa sổ chọn ROI cho camera đã chọn. Kiểm tra cửa sổ OpenCV và làm theo hướng dẫn...");
            window.location.href = selectUrl;
        });

        // --- Xử lý Submit Form Bắt đầu ---
        processForm.submit(function(e) {
            var selectedCameraId = cameraSelect.val();
            if (!selectedCameraId) {
                alert("Vui lòng chọn camera.");
                e.preventDefault();
                return false;
            }
            var mode = modeSelect.val();
            var username = $("#id_username").val();
            if (mode === 'collect' && !username) {
                 alert("Vui lòng nhập Username khi chọn chế độ Thu thập dữ liệu.");
                 e.preventDefault();
                 return false;
            }
            // Vô hiệu hóa nút Start và kích hoạt nút Stop (giao diện)
            startButton.prop('disabled', true);
            stopButton.prop('disabled', false);
            // Thay ảnh placeholder bằng stream
            videoStreamImg.attr("src", videoFeedUrl + "?t=" + new Date().getTime()); // Thêm timestamp để tránh cache

            // Submit form để Django xử lý phía server
            return true;
        });

         // --- Xử lý khi trang tải với tiến trình đang chạy --- 
        {% if is_processing %}
             startButton.prop('disabled', true);
             stopButton.prop('disabled', false);
             // Đảm bảo img src là URL video feed
             if (videoStreamImg.attr('src') !== videoFeedUrl) {
                 videoStreamImg.attr('src', videoFeedUrl + "?t=" + new Date().getTime());
             }
        {% else %}
             startButton.prop('disabled', false);
             stopButton.prop('disabled', true);
             // Đảm bảo img src là placeholder
              if (videoStreamImg.attr('src') !== placeholderSrc) {
                 videoStreamImg.attr('src', placeholderSrc);
             }
        {% endif %}

        // Optional: Reload image on error to try reconnecting (simple approach)
        // videoStreamImg.on('error', function() {
        //     console.log("Stream error, attempting reload...");
        //     setTimeout(() => {
        //         // Only reload if we are supposed to be processing
        //         if (stopButton.prop('disabled') === false) {
        //              $(this).attr('src', videoFeedUrl + "?t=" + new Date().getTime());
        //         }
        //     }, 5000); // Wait 5 seconds before retrying
        // });

    });
</script>

</body>
</html> 