{% load static %}
{% load crispy_forms_tags %}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Xử lý Video ROI</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@x.x.x/dist/select2-bootstrap4.min.css" rel="stylesheet" />
    <!-- Cropper.js CSS (Local) -->
    <link rel="stylesheet" href="{% static 'recognition/vendor/cropperjs/cropper.min.css' %}">
    <style>
        body {
            padding-top: 2rem;
            padding-bottom: 2rem;
            background-color: #f8f9fa; /* Light gray background */
        }
        .card {
            margin-bottom: 1.5rem; /* Thêm margin bottom */
        }
        .video-card .card-body {
            padding: 0.5rem; /* Giảm padding cho card video */
        }
        .roi-status {
            margin-bottom: 1rem;
            padding: 0.75rem 1.25rem;
            border: 1px solid transparent;
            border-radius: 0.25rem;
        }
        .roi-status-selected {
            color: #0f5132;
            background-color: #d1e7dd;
            border-color: #badbcc;
        }
        .roi-status-not-selected {
            color: #664d03;
            background-color: #fff3cd;
            border-color: #ffecb5;
        }
        .camera-section .form-group {
            display: flex;
            align-items: flex-start; /* Align items to the top */
            gap: 10px; /* Add some space between elements */
        }
        /* Allow crispy form group for camera to take up space */
        .camera-section .form-group > div {
             flex-grow: 1;
        }
        /* Adjust button size/margin if needed */
        .camera-section .btn-sm {
             margin-top: 5px; /* Add margin if needed */
        }
        .table-responsive {
            margin-top: 2rem;
        }
        .img-thumbnail {
            max-width: 100px;
            max-height: 100px;
        }
        .video-container {
            position: relative;
            width: 100%;
            background-color: #222; /* Darker background */
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: .25rem; /* Bo góc nhẹ */
        }
        .video-container img {
            height: auto; /* Giữ tỷ lệ */
            display: block;
            max-width: 100%; /* Giới hạn chiều rộng tối đa */
            max-height: 75vh; /* Giới hạn chiều cao theo viewport */
            margin: 0 auto;
        }
        .video-placeholder-text {
            position: absolute;
            color: #aaa;
            text-align: center;
            font-size: 1.2rem;
            padding: 2rem;
        }
        /* Hide placeholder text when the image source is the video feed */
        .video-container img[src*="video-feed"] + .video-placeholder-text {
            display: none;
        }
        /* Hide placeholder image when video feed is active (can use JS too) */
        /* Optional: Add class via JS when processing starts */
        .is-streaming .video-placeholder-text {
             display: none;
        }

        /* Ensure username field group is initially hidden if not collect */
        #username-field-group:not(.mode-collect) {
            display: none;
        }

        .control-buttons button {
            margin-right: 5px;
        }
        /* Style cho div username khi được di chuyển (tùy chọn) */
        #div_id_username.moved-username-field {
            margin-left: 25px; 
            margin-top: 5px; /* Tăng khoảng cách trên */
            margin-bottom: 15px; 
            border-left: 2px solid #eee; 
            padding-left: 15px;
            padding-top: 5px; /* Thêm padding trên nếu cần */
        }
        .attendance-table img {
            max-width: 50px; /* Giảm kích thước ảnh nhỏ hơn */
            max-height: 50px;
            border-radius: 4px;
        }
        .attendance-table th, .attendance-table td {
             vertical-align: middle;
             text-align: center;
             padding: 0.5rem; /* Giảm padding bảng */
        }
         .attendance-table th:nth-child(2), .attendance-table td:nth-child(2) { 
             text-align: left;
        }
        /* Style cho Cropper.js modal */
        #roi-editor-modal .modal-lg {
            max-width: 95%; /* Cho modal rộng hơn nữa */
        }
        #roi-image-container {
            max-height: 70vh; /* Giới hạn chiều cao container ảnh */
            overflow: hidden;
        }
        #roi-image {
             max-width: 100%; /* Đảm bảo ảnh không tràn container */
        }
        /* Ẩn vùng chọn mặc định của cropper ban đầu */
        .cropper-view-box, .cropper-face {
             border-radius: .25rem;
        }
        #collect-progress-label {
            font-size: 0.9rem; /* Hơi nhỏ hơn mặc định một chút */
            font-weight: 500;
            display: block; /* Đảm bảo nó chiếm 1 dòng */
            margin-bottom: 0.3rem;
        }

        #training-loading-indicator span {
            font-size: 0.95rem; /* Tăng kích thước chữ loading */
        }

        /* Tăng chiều cao cho bảng log */
        #attendance-log-container .table-responsive {
            max-height: 65vh; /* Chiều cao lớn hơn */
        }

        /* Cải thiện hiển thị nhà thầu đã chọn */
        .selected-contractor-display {
            min-height: 38px;
            display: flex;
            align-items: center;
            background-color: #f8f9fa;
        }
        
        /* Hiển thị lĩnh vực đã chọn */
        .selected-field-display {
            min-height: 38px;
            display: flex;
            align-items: center;
            background-color: #f8f9fa;
            border-left: 3px solid #17a2b8;
            padding-left: 10px;
        }
        
        /* Làm nổi bật nút chọn nhà thầu */
        .select-contractor-btn {
            margin-right: 3px;
        }
    </style>
</head>
<body data-is-processing="{% if is_processing %}true{% else %}false{% endif %}">

<div class="container-fluid mt-4"> 
    <div class="row">
        <!-- Cột Video Stream (Rộng hơn) -->
        <div class="col-lg-9 mb-4"> 
            <div class="card shadow-sm video-card"> 
                 <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center py-2"> <!-- Giảm padding header -->
                    <h5 class="mb-0 mr-auto">Video Stream</h5> <!-- Giảm cỡ chữ, thêm margin right -->
                     <button id="refresh-stream-btn" class="btn btn-light btn-sm mr-2" title="Làm mới Stream" {% if not is_processing %}disabled{% endif %}><i class="fas fa-sync-alt fa-xs"></i></button>
                     <form method="POST" style="display: inline;" id="stop-form">
                         {% csrf_token %}
                         <input type="hidden" name="action" value="stop">
                         <button type="button" id="stop-button" class="btn btn-danger btn-sm" {% if not is_processing %}disabled{% endif %}>
                             <i class="fas fa-stop"></i> Dừng
                         </button>
                     </form>
                </div>
                <div class="card-body">
                    <div class="video-container {% if is_processing %}is-streaming{% endif %}"> 
                        <img id="video-stream" 
                             src="{% if is_processing %}{% url 'video-feed' %}{% else %}{% static 'recognition/img/placeholder.png' %}{% endif %}" 
                             alt="Video Stream Area">
                        <div class="video-placeholder-text">
                             {% if not is_processing %}
                             Vui lòng chọn camera và bắt đầu xử lý.
                             {% endif %}
                         </div>
                     </div>
                </div>
             </div>
        </div>

        <!-- Cột Cấu hình & Log (Hẹp hơn) -->
        <div class="col-lg-3"> 
            <!-- Card Cấu hình -->
            <div class="card shadow-sm mb-4">
                 <div class="card-header bg-primary text-white py-2">
                    <h5 class="mb-0">Cấu hình & Điều khiển</h5>
                </div>
                <div class="card-body config-form"> 
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show small p-2" role="alert">
                                {{ message }}
                                <button type="button" class="close p-2" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <form method="POST" id="process-form" novalidate>
                        {% csrf_token %}
                        <input type="hidden" name="action" value="start">

                        <!-- Camera -->
                            <div class="form-group">
                                {{ form.camera|as_crispy_field }}
                             <div class="mt-1">
                                 <a href="{% url 'add-camera' %}" class="btn btn-success btn-sm" title="Thêm Camera Mới"><i class="fas fa-plus fa-xs"></i> Thêm</a>
                                 <a href="#" id="configure-roi-link" class="btn btn-secondary btn-sm ml-1" title="Cấu hình ROI"><i class="fas fa-edit fa-xs"></i> ROI</a>
                            </div>
                        </div>
                        <hr>
                        <!-- Mode -->
                         <div class="form-group">
                             <!-- <label class="mb-1">Chế độ xử lý:</label> --> <!-- Bỏ label chung -->
                             <div id="div_id_mode"> <!-- Giữ ID này để JS tìm -->
                            {{ form.mode|as_crispy_field }}
                        </div>
                         </div>
                         <!-- Username (sẽ được di chuyển) -->
                         <div class="form-group {% if form.mode.value != 'collect' %}d-none{% endif %}" id="div_id_username">
                             {{ form.username|as_crispy_field }}
                             
                             <!-- Thêm trường Email (ẩn ban đầu) -->
                             <div id="email-field-group" style="display: none;"> 
                                 {{ form.email|as_crispy_field }}
                             </div>
                             
                             <!-- Thêm trường Role -->
                             {{ form.role|as_crispy_field }}
                             
                             <!-- Thêm trường Supervisor (ẩn ban đầu) -->
                             <div id="supervisor-field-group" style="display: none;"> 
                                 {{ form.supervisor|as_crispy_field }}
                             </div>
                             
                             <!-- Thêm trường nhà thầu và lĩnh vực (ẩn ban đầu) -->
                             <div id="contractor-field-group" style="display: none;">
                                 <div class="form-group">
                                     <label for="contractor_select">Nhà thầu</label>
                                     <div class="input-group">
                                         <div class="form-control selected-contractor-display">
                                             <em class="text-muted">Chưa chọn nhà thầu</em>
                                         </div>
                                         <div class="input-group-append">
                                             <button type="button" id="choose_contractor_btn" class="btn btn-primary" title="Chọn nhà thầu">
                                                 <i class="fas fa-building"></i> Chọn
                                             </button>
                                         </div>
                                     </div>
                                     {{ form.contractor|as_crispy_field }}
                                 </div>
                                 
                                 <div class="form-group">
                                     <label for="field_display">Lĩnh vực</label>
                                     <div class="form-control selected-field-display">
                                         <em class="text-muted">Chưa có lĩnh vực</em>
                                     </div>
                                     {{ form.field|as_crispy_field }}
                                 </div>
                             </div>
                             
                             <!-- Thêm trường Company -->
                             {{ form.company|as_crispy_field }}
                             
                             <!-- Di chuyển nút Huấn luyện vào đây -->
                             <div class="mt-2 text-center">
                                 <button type="button" id="ajax-train-button" class="btn btn-info btn-sm">Huấn luyện Model</button>
                                 <!-- Thêm nút Xem Dataset vào đây -->
                                 <button type="button" id="view-dataset-btn" class="btn btn-secondary btn-sm ml-2"><i class="fas fa-images"></i> Xem Dataset</button>
                        </div>
                        </div>
                         <hr>
                         <!-- Nút Bắt đầu / Train -->
                         <div class="text-center control-buttons">
                             <button class="btn btn-primary" type="submit" {% if is_processing %}disabled{% endif %}>
                                  <i class="fas fa-play"></i> Bắt đầu
                              </button>
                 </div>
                          <!-- Progress bar for Data Collection -->
                          <div id="collect-progress-container" class="mt-3" style="display: none;">
                              <label id="collect-progress-label">Đang thu thập cho: </label>
                              <div class="progress">
                                  <div id="collect-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                 </div>
                </div>
                          <!-- Loading indicator for Training -->
                          <div id="training-loading-indicator" class="text-center mt-2" style="display: none;">
                              <span class="text-muted"><i class="fas fa-spinner fa-spin"></i> Đang huấn luyện...</span>
                </div>
                      </form>
            </div>
        </div>

        <!-- Hàng mới cho Log Chấm công -->
        <div class="row mt-3"> 
            <div class="col-12"> 
            <div class="card shadow-sm">
                    <div class="card-header bg-success text-white py-2 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Log Chấm công</h5>
                         <form method="get" id="log-filter-form" class="form-inline my-0">
                             <input type="date" class="form-control form-control-sm mr-1" name="start_date" title="Từ ngày" value="{{ start_date|default:'' }}" style="width: auto;">
                             <input type="date" class="form-control form-control-sm mr-1" name="end_date" title="Đến ngày" value="{{ end_date|default:'' }}" style="width: auto;">
                             <input type="text" class="form-control form-control-sm mr-1" style="width: 90px;" name="search" placeholder="Tìm tên..." value="{{ search_query|default:'' }}">
                             <button type="button" id="reload-log-btn" class="btn btn-light btn-sm" title="Tải lại"><i class="fas fa-sync-alt fa-xs"></i></button>
                         </form>
                </div>
                    <div class="card-body p-0" id="attendance-log-table-container"> 
                    {% include 'recognition/partials/attendance_log_table.html' %}
                </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ROI Editor Modal -->
<div class="modal fade" id="roi-editor-modal" tabindex="-1" role="dialog" aria-labelledby="roiModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="roiModalLabel">Chọn Vùng Quan Tâm (ROI)</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                 <p class="text-muted small">Kéo thả để vẽ vùng chữ nhật trên ảnh. Đảm bảo vùng chọn bao quanh khu vực bạn muốn theo dõi.</p>
                <div id="roi-image-container">
                    <img id="roi-image" src="" alt="ROI Frame">
                 </div>
                <div id="roi-loading-indicator" style="display: none; text-align: center; padding: 20px;">
                    <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                    <p>Đang tải frame...</p>
                </div>
                <div id="roi-error-message" class="alert alert-danger mt-2" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-info mr-auto" id="get-new-frame-btn">Lấy Frame Khác</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="cancel-roi-btn">Hủy</button>
                <button type="button" class="btn btn-primary" id="save-roi-btn">Lưu ROI</button>
            </div>
        </div>
    </div>
</div>

<!-- Dataset Viewer Modal -->
<div class="modal fade" id="dataset-viewer-modal" tabindex="-1" role="dialog" aria-labelledby="datasetViewerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="datasetViewerModalLabel">Xem Dataset Người dùng</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="dataset-username-select">Chọn Username:</label>
                    <select class="form-control" id="dataset-username-select">
                        <option value="">-- Chọn Username --</option>
                        <!-- Options sẽ được thêm bằng JavaScript -->
                    </select>
                </div>
                <hr>
                <div id="dataset-image-container" class="text-center" style="min-height: 150px;">
                    <!-- Ảnh sẽ được thêm bằng JavaScript -->
                     <p class="text-muted dataset-placeholder">Vui lòng chọn username để xem ảnh.</p>
                     <div class="spinner-border text-primary dataset-loading" role="status" style="display: none;">
                         <span class="sr-only">Đang tải ảnh...</span>
                     </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Quản lý Nhà thầu -->
<div class="modal fade" id="contractors-manager-modal" tabindex="-1" role="dialog" aria-labelledby="contractorsManagerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="contractorsManagerModalLabel">Quản lý Danh sách Nhà thầu và Lĩnh vực</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <p>Chức năng này cho phép bạn quản lý danh sách nhà thầu và lĩnh vực công việc. Nhấn vào <b>Chọn</b> để sử dụng thông tin.</p>
                </div>
                
                <!-- Form thêm mới nhà thầu và lĩnh vực -->
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">Thêm mới</h6>
                        <div class="form-row">
                            <div class="col-md-5 mb-2">
                                <input type="text" class="form-control" id="new-contractor-name" placeholder="Tên nhà thầu">
                            </div>
                            <div class="col-md-5 mb-2">
                                <input type="text" class="form-control" id="new-contractor-field" placeholder="Lĩnh vực công việc">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-success btn-block" id="add-contractor-btn">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tìm kiếm -->
                <div class="form-group">
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                        </div>
                        <input type="text" class="form-control" id="contractor-search" placeholder="Tìm kiếm...">
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped table-bordered" id="contractors-table">
                        <thead>
                            <tr>
                                <th>Tên nhà thầu</th>
                                <th>Lĩnh vực</th>
                                <th class="text-center">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Danh sách nhà thầu sẽ được thêm ở đây bằng JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<!-- Replace slim jQuery with full version -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<!-- Cropper.js JS (Local) -->
<script src="{% static 'recognition/vendor/cropperjs/cropper.min.js' %}"></script>
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    $(document).ready(function() {
        // --- Selectors --- 
        var cameraSelect = $('#id_camera');
        // var modeSelect = $('#id_mode'); // Vẫn cần để lấy giá trị ban đầu nếu dùng crispy tag
        var usernameFieldGroup = $('#div_id_username');
        var emailFieldGroup = $('#email-field-group'); // Thêm selector cho nhóm email
        var supervisorFieldGroup = $('#supervisor-field-group'); // Thêm selector cho nhóm supervisor
        var contractorFieldGroup = $('#contractor-field-group'); // Selector cho nhóm nhà thầu
        var chooseContractorBtn = $('#choose_contractor_btn'); // Nút chọn nhà thầu
        var manageContractorsBtn = $('#manage_contractors_btn'); // Nút quản lý danh sách nhà thầu
        var contractorInput = $('#id_contractor'); // Input field cho nhà thầu
        var fieldInput = $('#id_field'); // Input field cho lĩnh vực
        var selectedContractorDisplay = $('.selected-contractor-display'); // Phần hiển thị nhà thầu đã chọn
        var selectedFieldDisplay = $('.selected-field-display'); // Phần hiển thị lĩnh vực đã chọn
        var processForm = $("#process-form");
        var startButton = processForm.find("button[type='submit']");
        var stopButton = $("#stop-button"); // Cập nhật selector
        var stopForm = $("#stop-form"); // Thêm selector cho form dừng
        var videoStreamImg = $("#video-stream");
        var videoContainer = $(".video-container");
        var placeholderText = $(".video-placeholder-text");
        var placeholderSrc = "{% static 'recognition/img/placeholder.png' %}";
        var videoFeedUrl = "{% url 'video-feed' %}";
        var collectRadioButtonLabel;
        // ROI Modal elements
        var roiModal = $('#roi-editor-modal');
        var roiImage = $('#roi-image');
        var saveRoiButton = $('#save-roi-btn');
        var cancelRoiButton = $('#cancel-roi-btn');
        var cropper = null; // Cropper instance
        var refreshStreamBtn = $('#refresh-stream-btn'); // Nút refresh mới
        var currentCameraIdForRoi = null;
        var trainButton = $('#ajax-train-button'); // Selector cho nút train mới
        var getNewFrameButton = $('#get-new-frame-btn');
        var roiLoadingIndicator = $('#roi-loading-indicator');
        var roiErrorMessage = $('#roi-error-message');
        // Log elements
        var logFilterForm = $('#log-filter-form');
        var reloadLogButton = $('#reload-log-btn');
        var logTableContainer = $('#attendance-log-table-container');
        // Progress/Loading elements
        var collectProgressContainer = $('#collect-progress-container');
        var collectProgressBar = $('#collect-progress-bar');
        var collectProgressLabel = $('#collect-progress-label');
        var trainingLoadingIndicator = $('#training-loading-indicator');
        var progressInterval = null; // Interval ID for progress update
        // Dataset Viewer Modal elements
        var viewDatasetBtn = $('#view-dataset-btn');
        var datasetModal = $('#dataset-viewer-modal');
        var usernameSelect = $('#dataset-username-select');
        var imageContainer = $('#dataset-image-container');
        var datasetPlaceholder = imageContainer.find('.dataset-placeholder');
        var datasetLoading = imageContainer.find('.dataset-loading');

        // --- Move Username Field --- 
        try {
            // Tìm label của radio 'collect' bên trong div_id_mode do crispy tạo
             collectRadioButtonLabel = $('#div_id_mode input[name="mode"][value="collect"]').closest('.form-check').find('label.form-check-label');
             if (collectRadioButtonLabel.length > 0 && usernameFieldGroup.length > 0) {
                 usernameFieldGroup.insertAfter(collectRadioButtonLabel).addClass('moved-username-field'); 
                 // Ẩn label mặc định của crispy cho username
                 usernameFieldGroup.find('label.col-form-label').hide(); 
                 console.log("Moved username field.");
             } else { console.warn("Cannot find elements to move username field."); }
        } catch (e) { console.error("Error moving username field:", e); }

        // --- Khởi tạo UI cho trường Contractor và Field ---
        // Ẩn input field của contractor và field
        contractorInput.closest('.form-group').find('label').hide();
        contractorInput.hide();
        fieldInput.closest('.form-group').find('label').hide();
        fieldInput.hide();

        // Xử lý sự kiện khi nhấn nút chọn nhà thầu
        chooseContractorBtn.click(function() {
            // Hiển thị modal chọn nhà thầu
            $('#contractors-manager-modal').modal('show');
            
            // Tải danh sách nhà thầu từ localStorage nếu có
            loadContractorsFromLocalStorage();
        });
        
        // Hàm lưu danh sách nhà thầu vào localStorage
        function saveContractorsToLocalStorage() {
            var contractors = [];
            $('#contractors-table tbody tr').each(function() {
                contractors.push({
                    name: $(this).data('contractor'),
                    field: $(this).data('field')
                });
            });
            localStorage.setItem('contractors_list', JSON.stringify(contractors));
            
            // Đồng bộ danh sách nhà thầu lên Firebase
            saveContractorsToFirebase(contractors);
        }
        
        // Hàm đồng bộ danh sách nhà thầu lên Firebase
        function saveContractorsToFirebase(contractors) {
            // Lấy CSRF token
            var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
            
            $.ajax({
                url: "{% url 'save-contractor-to-firebase' %}",
                type: "POST",
                data: JSON.stringify({ contractors: contractors }),
                contentType: "application/json",
                headers: {
                    "X-CSRFToken": csrfToken
                },
                success: function(response) {
                    console.log("[Firebase] Đồng bộ nhà thầu thành công:", response);
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("[Firebase] Lỗi khi đồng bộ nhà thầu:", textStatus, errorThrown);
                    console.error("[Firebase] Lỗi chi tiết:", jqXHR.responseText);
                }
            });
        }
        
        // Hàm tải danh sách nhà thầu từ localStorage
        function loadContractorsFromLocalStorage() {
            var contractorsJson = localStorage.getItem('contractors_list');
            if (contractorsJson) {
                try {
                    var contractors = JSON.parse(contractorsJson);
                    $('#contractors-table tbody').empty();
                    contractors.forEach(function(contractor) {
                        var newRow = `
                            <tr data-contractor="${contractor.name}" data-field="${contractor.field || ''}">
                                <td>${contractor.name}</td>
                                <td>${contractor.field || '<em class="text-muted">Chưa có</em>'}</td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-primary select-contractor-btn" title="Chọn nhà thầu này">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn btn-sm btn-secondary edit-contractor-btn" title="Sửa thông tin">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-contractor-btn" title="Xóa nhà thầu">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                        $('#contractors-table tbody').append(newRow);
                    });
                } catch (e) {
                    console.error("Lỗi khi tải danh sách nhà thầu:", e);
                }
            }
        }
        
        // Xử lý sự kiện chọn nhà thầu từ modal
        $(document).on('click', '.select-contractor-btn', function() {
            var row = $(this).closest('tr');
            var contractorName = row.data('contractor');
            var fieldValue = row.data('field');
            
            // Cập nhật giá trị vào input
            contractorInput.val(contractorName);
            fieldInput.val(fieldValue);
            
            // Cập nhật hiển thị
            selectedContractorDisplay.html(`<strong>${contractorName}</strong>`);
            
            // Hiển thị lĩnh vực nếu có
            if (selectedFieldDisplay.length > 0) {
                if (fieldValue) {
                    selectedFieldDisplay.html(`<strong>${fieldValue}</strong>`);
                } else {
                    selectedFieldDisplay.html('<em class="text-muted">Chưa có lĩnh vực</em>');
                }
            }
            
            // Đóng modal
            $('#contractors-manager-modal').modal('hide');
        });
        
        // Tìm kiếm nhà thầu trong bảng
        $('#contractor-search').on('keyup', function() {
            var value = $(this).val().toLowerCase();
            $('#contractors-table tbody tr').filter(function() {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
            });
        });

        // Thêm nhà thầu mới vào bảng
        $('#add-contractor-btn').click(function() {
            var contractorName = $('#new-contractor-name').val().trim();
            var fieldValue = $('#new-contractor-field').val().trim();
            
            if (!contractorName) {
                alert('Vui lòng nhập tên nhà thầu!');
                return;
            }
            
            // Kiểm tra trùng lặp
            var isDuplicate = false;
            $('#contractors-table tbody tr').each(function() {
                if ($(this).data('contractor') === contractorName) {
                    isDuplicate = true;
                    return false;
                }
            });
            
            if (isDuplicate) {
                alert('Nhà thầu này đã tồn tại!');
                return;
            }
            
            // Thêm hàng mới
            var newRow = `
                <tr data-contractor="${contractorName}" data-field="${fieldValue}">
                    <td>${contractorName}</td>
                    <td>${fieldValue || '<em class="text-muted">Chưa có</em>'}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-primary select-contractor-btn" title="Chọn nhà thầu này">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-sm btn-secondary edit-contractor-btn" title="Sửa thông tin">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger delete-contractor-btn" title="Xóa nhà thầu">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            
            $('#contractors-table tbody').append(newRow);
            
            // Xóa giá trị nhập
            $('#new-contractor-name').val('');
            $('#new-contractor-field').val('');
            
            // Lưu danh sách nhà thầu vào localStorage
            saveContractorsToLocalStorage();
        });
        
        // Xử lý sự kiện sửa nhà thầu
        $(document).on('click', '.edit-contractor-btn', function() {
            var row = $(this).closest('tr');
            var contractorName = row.data('contractor');
            var fieldValue = row.data('field') || '';
            
            // Hiển thị form sửa trực tiếp trong hàng
            row.html(`
                <td>
                    <input type="text" class="form-control edit-contractor-name" value="${contractorName}">
                </td>
                <td>
                    <input type="text" class="form-control edit-contractor-field" value="${fieldValue}">
                </td>
                <td class="text-center">
                    <button class="btn btn-sm btn-success save-edit-btn">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="btn btn-sm btn-danger cancel-edit-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            `);
        });
        
        // Lưu chỉnh sửa nhà thầu
        $(document).on('click', '.save-edit-btn', function() {
            var row = $(this).closest('tr');
            var oldName = row.data('contractor');
            var newName = row.find('.edit-contractor-name').val().trim();
            var newField = row.find('.edit-contractor-field').val().trim();
            
            if (!newName) {
                alert('Tên nhà thầu không được để trống!');
                return;
            }
            
            // Kiểm tra trùng lặp nếu tên thay đổi
            if (oldName !== newName) {
                var isDuplicate = false;
                $('#contractors-table tbody tr').not(row).each(function() {
                    if ($(this).data('contractor') === newName) {
                        isDuplicate = true;
                        return false;
                    }
                });
                
                if (isDuplicate) {
                    alert('Nhà thầu này đã tồn tại!');
                    return;
                }
            }
            
            // Cập nhật dữ liệu hàng
            row.data('contractor', newName);
            row.data('field', newField);
            
            // Cập nhật hiển thị hàng
            row.html(`
                <td>${newName}</td>
                <td>${newField || '<em class="text-muted">Chưa có</em>'}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-primary select-contractor-btn" title="Chọn nhà thầu này">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="btn btn-sm btn-secondary edit-contractor-btn" title="Sửa thông tin">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger delete-contractor-btn" title="Xóa nhà thầu">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `);
            
            // Cập nhật giá trị hiển thị nếu đang chọn nhà thầu này
            if (contractorInput.val() === oldName) {
                contractorInput.val(newName);
                fieldInput.val(newField);
                selectedContractorDisplay.html(`<strong>${newName}</strong>`);
                
                if (selectedFieldDisplay.length > 0) {
                    if (newField) {
                        selectedFieldDisplay.html(`<strong>${newField}</strong>`);
                    } else {
                        selectedFieldDisplay.html('<em class="text-muted">Chưa có lĩnh vực</em>');
                    }
                }
            }
            
            // Lưu danh sách nhà thầu vào localStorage
            saveContractorsToLocalStorage();
        });
        
        // Hủy chỉnh sửa
        $(document).on('click', '.cancel-edit-btn', function() {
            var row = $(this).closest('tr');
            var contractorName = row.data('contractor');
            var fieldValue = row.data('field') || '';
            
            // Phục hồi hiển thị hàng
            row.html(`
                <td>${contractorName}</td>
                <td>${fieldValue || '<em class="text-muted">Chưa có</em>'}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-primary select-contractor-btn" title="Chọn nhà thầu này">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="btn btn-sm btn-secondary edit-contractor-btn" title="Sửa thông tin">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger delete-contractor-btn" title="Xóa nhà thầu">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `);
        });
        
        // Xóa nhà thầu
        $(document).on('click', '.delete-contractor-btn', function() {
            if (!confirm('Bạn có chắc muốn xóa nhà thầu này?')) {
                return;
            }
            
            var row = $(this).closest('tr');
            var contractorName = row.data('contractor');
            
            // Xóa hàng
            row.remove();
            
            // Cập nhật giá trị hiển thị nếu đang chọn nhà thầu này
            if (contractorInput.val() === contractorName) {
                contractorInput.val('');
                fieldInput.val('');
                selectedContractorDisplay.html('<em class="text-muted">Chưa chọn nhà thầu</em>');
                
                if (selectedFieldDisplay.length > 0) {
                    selectedFieldDisplay.html('<em class="text-muted">Chưa có lĩnh vực</em>');
                }
            }
            
            // Lưu danh sách nhà thầu vào localStorage
            saveContractorsToLocalStorage();
        });

        // --- Function to toggle Username field --- 
        function toggleConditionalFields() { // Đổi tên hàm cho rõ ràng hơn
            var selectedMode = $('input[name="mode"]:checked').val();
            if (selectedMode === 'collect') {
                usernameFieldGroup.removeClass('d-none');
                // Xử lý hiển thị Email và Supervisor dựa trên Role
                var selectedRole = $('input[name="role"]:checked').val(); // Lấy giá trị từ radio được chọn
                if (selectedRole === 'worker') {
                    supervisorFieldGroup.show();
                    contractorFieldGroup.show(); // Hiển thị nhà thầu cho worker
                    emailFieldGroup.hide(); // Ẩn email cho worker
                } else if (selectedRole === 'supervisor') {
                    supervisorFieldGroup.hide(); // Ẩn supervisor cho supervisor
                    contractorFieldGroup.hide(); // Ẩn nhà thầu cho supervisor
                    emailFieldGroup.show(); // Hiện email cho supervisor
                } else {
                    supervisorFieldGroup.hide();
                    contractorFieldGroup.hide(); // Ẩn nhà thầu khi chưa chọn vai trò
                    emailFieldGroup.hide(); // Ẩn cả hai nếu chưa chọn role
                }
                    // Hiển thị nút huấn luyện nếu là mode collect
                    $('#ajax-train-button').parent().removeClass('d-none'); 
            } else {
                usernameFieldGroup.addClass('d-none');
                // Ẩn luôn nút huấn luyện khi không phải mode collect
                $('#ajax-train-button').parent().addClass('d-none'); 
                // Ẩn luôn field supervisor khi không phải mode collect
                supervisorFieldGroup.hide(); 
                // Ẩn luôn field email khi không phải mode collect
                emailFieldGroup.hide(); 
                // Ẩn luôn field contractor khi không phải mode collect
                contractorFieldGroup.hide();
            } 
        }
        // Chạy lần đầu để đảm bảo trạng thái đúng dựa trên giá trị initial của form
        toggleConditionalFields(); 
        // Gắn vào sự kiện change của radio buttons mode
        $('input[name="mode"]').change(toggleConditionalFields); 
        // Gắn vào sự kiện change của select role
        $('input[name="role"]').change(toggleConditionalFields); // Gắn sự kiện cho tất cả radio trong nhóm 'role'

        // --- Alert closing, Train Button, Configure ROI Link --- 
        $('.alert .close').on('click', function(e) { $(this).parent().alert('close'); });
        $("#ajax-train-button").click(function(e){
            e.preventDefault(); // Ngăn hành vi mặc định của button

            if (!confirm("Bắt đầu huấn luyện? Quá trình này có thể mất vài phút và không thể hủy ngang.")) { 
                return;
            } else {
                trainingLoadingIndicator.show();
                $(this).prop('disabled', true); // Vô hiệu hóa nút trong khi huấn luyện

                var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

                $.ajax({
                   url: "{% url 'ajax-train' %}", // URL mới cần tạo trong urls.py
                   type: "POST",
                   headers: { "X-CSRFToken": csrfToken },
                   dataType: "json",
                   success: function(response) {
                       trainingLoadingIndicator.hide();
                       trainButton.prop('disabled', false);
                       if(response.status === 'success') {
                           alert("Huấn luyện thành công!"); // Hoặc hiển thị message đẹp hơn
                       } else {
                           alert("Lỗi huấn luyện: " + response.message);
                       }
                   },
                   error: function(jqXHR, textStatus, errorThrown) {
                       trainingLoadingIndicator.hide();
                       trainButton.prop('disabled', false);
                       console.error("[Train AJAX Error] Status:", textStatus, "Error:", errorThrown, jqXHR.responseText);
                       alert("Lỗi kết nối hoặc lỗi server khi huấn luyện. Vui lòng kiểm tra log server.");
                   }
                });
            }
        });
        $("#configure-roi-link").click(function(e){
            e.preventDefault();
            currentCameraIdForRoi = cameraSelect.val();
            if (!currentCameraIdForRoi) {
                alert("Vui lòng chọn một camera trước khi cấu hình ROI.");
                return;
            }
            // Hiển thị modal NGAY LẬP TỨC
            roiModal.modal('show'); 
            // Sau đó mới bắt đầu tải frame
            fetchAndDisplayRoiFrame(currentCameraIdForRoi); 
        });

        // --- Function to fetch and display static frame for ROI --- 
        function fetchAndDisplayRoiFrame(cameraId) {
            console.log("[ROI] Fetching static frame for camera:", cameraId);
            if (cropper) { // Hủy cropper cũ trước khi tải ảnh mới
                cropper.destroy();
                cropper = null;
            }
            roiImage.attr('src', '').hide(); // Xóa ảnh cũ và ẩn đi
            roiErrorMessage.hide();
            roiLoadingIndicator.show();
            getNewFrameButton.prop('disabled', true);
            saveRoiButton.prop('disabled', true);

            var frameUrl = `/get_static_frame/${cameraId}/?t=${new Date().getTime()}`; // Thêm timestamp để tránh cache

            // Sử dụng fetch để tải ảnh (cho phép kiểm tra status code)
            fetch(frameUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Lỗi ${response.status}: ${response.statusText}`);
                    }
                    return response.blob(); // Lấy dữ liệu ảnh dạng blob
                })
                .then(blob => {
                    var objectURL = URL.createObjectURL(blob);
                    roiImage.attr('src', objectURL); // Đặt src là URL của blob
                    roiLoadingIndicator.hide();
                    roiImage.show(); // Hiển thị ảnh
                    // Khởi tạo Cropper sau khi ảnh mới được hiển thị
                    initializeCropper(); 
                    getNewFrameButton.prop('disabled', false);
                    saveRoiButton.prop('disabled', false);
                })
                .catch(error => {
                    console.error("[ROI] Error fetching static frame:", error);
                    roiLoadingIndicator.hide();
                    roiErrorMessage.text(`Không thể tải frame từ camera. Lỗi: ${error.message}`).show();
                    getNewFrameButton.prop('disabled', false);
                    // Không bật nút save nếu không có ảnh
                });
        }
        
        // --- Function to initialize Cropper --- 
        function initializeCropper() {
             if (cropper) {
                cropper.destroy();
                console.log("[Cropper] Destroyed existing instance.");
             }
             if (typeof Cropper === 'undefined') {
                 console.error("[Cropper Error] Thư viện Cropper.js chưa được tải hoặc định nghĩa.");
                 roiErrorMessage.text("Lỗi: Không thể khởi tạo công cụ chọn ROI. Vui lòng tải lại trang.").show();
                 saveRoiButton.prop('disabled', true);
                 getNewFrameButton.prop('disabled', false); // Vẫn cho phép lấy frame khác
                 return; // Dừng thực thi hàm này
             }
             
             if (roiImage.attr('src')) {
                 console.log("[Cropper] Initializing on image:", roiImage.attr('src'));
                 cropper = new Cropper(roiImage[0], {
                    aspectRatio: NaN,
                    viewMode: 1,
                    background: false,
                    autoCropArea: 0.8, 
                    movable: true,
                    cropBoxResizable: true,
                    ready: function () {
                        console.log("[Cropper] Cropper is ready.");
                        saveRoiButton.prop('disabled', false); // Bật nút Save khi cropper sẵn sàng
                    }
                 });
              } else {
                   console.warn("[Cropper] No image src to initialize Cropper on.");
                    saveRoiButton.prop('disabled', true); // Tắt nút Save nếu không có ảnh
              }
        }

        // --- Stop Button Click Handling (AJAX Version) --- 
        stopButton.click(function(e) {
            e.preventDefault(); // Ngăn hành vi mặc định

            if (!confirm("Bạn có chắc muốn dừng tiến trình?")) {
                return;
            }

            var csrfToken = stopForm.find('input[name="csrfmiddlewaretoken"]').val();
            var stopUrl = "{% url 'process-video-roi' %}"; // Lấy URL từ Django

            // Vô hiệu hóa nút Dừng và Refresh ngay lập tức để tránh nhấn nhiều lần
            $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Dừng...');
            refreshStreamBtn.prop('disabled', true);

            $.ajax({
                url: stopUrl,
                type: "POST",
                data: { action: 'stop', csrfmiddlewaretoken: csrfToken },
                dataType: "json",
                success: function(response) {
                    console.log("[Stop AJAX Success] Response:", response);
                    // Cập nhật UI khi dừng thành công
                    startButton.prop('disabled', false).html('<i class="fas fa-play"></i> Bắt đầu');
                    stopButton.prop('disabled', true).html('<i class="fas fa-stop"></i> Dừng'); // Reset text nút dừng
                    refreshStreamBtn.prop('disabled', true);
                    videoStreamImg.attr('src', placeholderSrc); // Hiện placeholder
                    placeholderText.text("Đã dừng xử lý.").show();
                    videoContainer.removeClass('is-streaming');
                    $("body").data("is-processing", false);

                    // Dừng cập nhật progress nếu đang chạy
                    if (progressInterval) {
                        clearInterval(progressInterval);
                        progressInterval = null;
                        collectProgressContainer.hide();
                        console.log("[Progress] Stopped interval due to successful stop.");
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("[Stop AJAX Error] Status:", textStatus, "Error:", errorThrown, jqXHR.responseText);
                    alert("Lỗi khi gửi yêu cầu dừng. Vui lòng thử lại.");
                    // Kích hoạt lại nút Dừng nếu lỗi để người dùng thử lại
                    stopButton.prop('disabled', false).html('<i class="fas fa-stop"></i> Dừng');
                    // Giữ nút refresh disabled vì không chắc chắn trạng thái stream
                }
            });
        });

        // --- Function to update Collection Progress Bar --- 
        function updateCollectProgress() {
            $.ajax({
                url: "{% url 'get-collect-progress' %}", 
                type: "GET",
                dataType: "json",
                success: function(progressData) {
                    console.log("[Progress AJAX Success] Data received: ", JSON.stringify(progressData)); // Log dữ liệu nhận được
                    // --- Lấy username gốc từ input field --- 
                    var currentUsername = $("#id_username").val();
                    var progressStatusText = "Không có tiến trình thu thập nào đang chạy."; // Default text
                    var activeCollectionUser = null;
                    var userProgress = null;

                    // Kiểm tra xem username hiện tại có trong progressData và đang active không
                    if (currentUsername && progressData.hasOwnProperty(currentUsername) && progressData[currentUsername].active) {
                        activeCollectionUser = currentUsername;
                        userProgress = progressData[currentUsername];
                    } else {
                        // Nếu user hiện tại không active, thử tìm user khác đang active (ít khả năng xảy ra nhưng để phòng ngừa)
                        for (var userKey in progressData) {
                           if (progressData.hasOwnProperty(userKey) && progressData[userKey].active) {
                               activeCollectionUser = userKey;
                               userProgress = progressData[userKey];
                               break;
                           }
                       }
                    }
                    // --- Kết thúc lấy username gốc và kiểm tra ---

                    if (activeCollectionUser) {
                        var current = userProgress.current || 0;
                        var total = userProgress.total || 1; // Tránh chia cho 0
                        var percentage = Math.round((current / total) * 100);
                        progressStatusText = `Đang thu thập cho: ${activeCollectionUser} (${current}/${total})`;
                        collectProgressLabel.text(progressStatusText);
                        collectProgressBar.css('width', percentage + '%').attr('aria-valuenow', percentage).text(percentage + '%');
                        collectProgressContainer.show();
                        if (!progressInterval) { // Nếu interval chưa chạy, bắt đầu nó
                            progressInterval = setInterval(updateCollectProgress, 1500); // Cập nhật mỗi 1.5 giây
                            console.log("[Progress] Started interval.");
                        }
                    } else {
                        // Không có user nào đang active
                        collectProgressLabel.text(progressStatusText); // Hiển thị trạng thái mặc định nếu không có gì chạy
                        collectProgressContainer.hide();
                        if (progressInterval) { // Nếu không có gì active, dừng interval
                            clearInterval(progressInterval);
                            progressInterval = null;
                            console.log("[Progress] Stopped interval.");
                        }
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) { // Thêm tham số lỗi
                    console.error(`[Progress AJAX Error] Status: ${textStatus}, Error: ${errorThrown}`); // Log chi tiết lỗi
                    console.warn("[Progress] Could not fetch progress data. Hiding bar and stopping interval.");
                    // Optionally hide progress bar on error or keep last state
                    collectProgressContainer.hide(); // Ẩn thanh tiến trình khi lỗi
                    if (progressInterval) { // Dừng interval nếu lỗi
                        clearInterval(progressInterval);
                        progressInterval = null;
                    }
                }
            });
        }

        // --- Save ROI Button Click --- 
        saveRoiButton.click(function() {
            if (!cropper || !currentCameraIdForRoi) {
                console.error("Cropper chưa khởi tạo hoặc camera ID bị thiếu.");
                alert("Đã có lỗi xảy ra. Vui lòng thử lại.");
                return;
            }

            var cropData = cropper.getData({ rounded: true }); // Lấy tọa độ làm tròn
            var imageData = cropper.getImageData(); // Lấy thông tin kích thước ảnh gốc

            console.log("Crop Data:", cropData);
            console.log("Image Data:", imageData);

            // Chuẩn bị dữ liệu gửi đi
            var postData = {
                camera_id: currentCameraIdForRoi,
                crop_data: cropData, // { x, y, width, height, rotate, scaleX, scaleY }
                natural_width: imageData.naturalWidth,
                natural_height: imageData.naturalHeight
            };

             // Lấy CSRF token
             var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

            // Gửi AJAX request
            $.ajax({
                url: "/save_roi/" + currentCameraIdForRoi + "/", // URL cần tạo ở Django
                type: "POST",
                contentType: "application/json", // Gửi dạng JSON
                data: JSON.stringify(postData), // Chuyển object thành JSON string
                headers: { "X-CSRFToken": csrfToken }, // Thêm CSRF token vào header
                dataType: "json", // Mong đợi nhận về JSON
                success: function(response) {
                    console.log("Save ROI Response:", response);
                    if (response.status === 'success') {
                        alert("Đã lưu ROI thành công!");
                        roiModal.modal('hide'); // Đóng modal
                    } else {
                         alert("Lỗi khi lưu ROI: " + (response.message || "Unknown error"));
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("AJAX Error:", textStatus, errorThrown, jqXHR.responseText);
                    alert("Lỗi kết nối hoặc lỗi server khi lưu ROI. Chi tiết: " + textStatus);
                }
            });
        });

        // --- Start Form Submission (AJAX Version) --- 
        processForm.submit(function(e) {
            e.preventDefault(); // Ngăn chặn gửi form truyền thống

            // Basic Validation (Client-side)
            if (!cameraSelect.val()) { alert("Vui lòng chọn camera."); return false; }
            var selectedMode = $('input[name="mode"]:checked').val();
            var username = $("#id_username").val();
            if (selectedMode === 'collect' && !username) { alert("Vui lòng nhập Username cho chế độ Thu thập."); return false; }
            
            // Thêm validation cho Role và Supervisor nếu cần
            var selectedRole = $('input[name="role"]:checked').val(); // Lấy giá trị role từ radio đã chọn
            if (selectedMode === 'collect' && !selectedRole) { 
                alert("Vui lòng chọn Vai trò."); 
                return false; 
            }
            // Validation cho worker
            if (selectedMode === 'collect' && selectedRole === 'worker') {
                var selectedSupervisor = $('#id_supervisor').val(); // Lấy giá trị supervisor
                if (!selectedSupervisor) { 
                    alert("Vui lòng chọn Supervisor cho Worker."); 
                    return false; 
                }
                
                // Validation cho nhà thầu và lĩnh vực
                var contractorValue = contractorInput.val();
                var fieldValue = fieldInput.val();
                
                if (!contractorValue) {
                    alert("Vui lòng chọn Nhà thầu cho Worker.");
                    return false;
                }
                
                if (!fieldValue) {
                    alert("Vui lòng nhập Lĩnh vực công việc cho Worker.");
                    return false;
                }
            }
            // Validation cho supervisor
            if (selectedMode === 'collect' && selectedRole === 'supervisor') {
                var emailValue = $('#id_email').val(); // Lấy giá trị email
                if (!emailValue) { 
                    alert("Vui lòng nhập Email cho Supervisor."); 
                    return false; 
                }
            }
            
            // Disable start button, enable stop button
            startButton.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Bắt đầu...');

            var formData = $(this).serialize(); // Lấy dữ liệu form: action=start&csrfmiddlewaretoken=...&camera=...&mode=...&username=...

            console.log("[Start AJAX] Sending form data:", formData);

            $.ajax({
                url: $(this).attr('action'), // URL của form (/process_video_roi/)
                type: "POST",
                data: formData,
                dataType: "json", // Mong đợi JSON response từ view
                success: function(response) {
                    console.log("[Start AJAX Success] Response:", response);
                    if (response.status === 'success') {
                        // Cập nhật UI khi thành công
                        stopButton.prop('disabled', false);
                        refreshStreamBtn.prop('disabled', false);
                        placeholderText.hide();
                        videoContainer.addClass('is-streaming');
                        videoStreamImg.attr("src", videoFeedUrl + "?ts=" + new Date().getTime());
                        $("body").data("is-processing", true); // Cập nhật trạng thái data attribute
                        
                        // Bắt đầu cập nhật progress bar chỉ khi backend báo thành công
                        if ($('input[name="mode"]:checked').val() === 'collect') {
                            console.log("[Progress] Starting progress updates after successful start.");
                            if (progressInterval) clearInterval(progressInterval);
                            setTimeout(updateCollectProgress, 150); // Chờ lâu hơn chút
                        }
                        // Hiển thị message thành công từ backend (nếu có)
                        if(response.message) {
                             console.log("Backend message:", response.message);
                        }
                        // --- Kích hoạt lại nút Start sau khi thành công --- 
                        startButton.prop('disabled', false).html('<i class="fas fa-play"></i> Bắt đầu');
                    // --- THÊM XỬ LÝ CHO WARNING --- 
                    } else if (response.status === 'warning') { 
                        // Trường hợp camera đã chạy, chỉ hiển thị thông báo
                        alert(response.message); 
                        // Giữ nguyên trạng thái nút Start (vẫn disabled vì đang chạy?)
                        // Cần kích hoạt lại nút start để người dùng có thể chọn camera khác
                        startButton.prop('disabled', false).html('<i class="fas fa-play"></i> Bắt đầu'); 
                        // Không thay đổi trạng thái nút Stop/Refresh
                    // --- KẾT THÚC THÊM ---
                    } else { 
                        // Xử lý lỗi từ backend (vd: form invalid)
                        alert("Lỗi khi bắt đầu xử lý: " + response.message);
                        // Reset nút Start về trạng thái ban đầu
                        startButton.prop('disabled', false).html('<i class="fas fa-play"></i> Bắt đầu');
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("[Start AJAX Error] Status:", textStatus, "Error:", errorThrown, jqXHR.responseText);
                    alert("Lỗi kết nối hoặc lỗi server khi gửi yêu cầu bắt đầu.");
                    // Reset nút Start về trạng thái ban đầu khi có lỗi kết nối/server
                    startButton.prop('disabled', false).html('<i class="fas fa-play"></i> Bắt đầu');
                }
            });

        });

         // --- Initial state based on is_processing --- 
        if ($("body").data("is-processing")) {
             startButton.prop('disabled', true);
             stopButton.prop('disabled', false);
             refreshStreamBtn.prop('disabled', false);
             placeholderText.hide();
             videoContainer.addClass('is-streaming');
             if (videoStreamImg.attr('src') !== videoFeedUrl) {
                 videoStreamImg.attr('src', videoFeedUrl + "?ts=" + new Date().getTime());
             }
        } else {
             // Reset nút Start về trạng thái ban đầu
             startButton.prop('disabled', false).html('<i class="fas fa-play"></i> Bắt đầu'); 
             stopButton.prop('disabled', true);
             refreshStreamBtn.prop('disabled', true);
             placeholderText.show();
             videoContainer.removeClass('is-streaming');
              // Đảm bảo hiển thị ảnh placeholder nếu không xử lý
              if (videoStreamImg.attr('src') !== placeholderSrc) {
                 videoStreamImg.attr('src', placeholderSrc);
             }
        }

        // --- Error handling for video stream --- 
        videoStreamImg.on('error', function() {
            // Chỉ xử lý lỗi nếu đang ở trạng thái is-streaming
            if (videoContainer.hasClass('is-streaming')) {
                console.error("Video stream error/stopped.");
                $(this).attr('src', placeholderSrc); // Hiển thị lại placeholder
                placeholderText.text("Lỗi stream hoặc đã dừng.").show(); // Hiển thị thông báo lỗi
                 // Reset trạng thái nút
                 startButton.prop('disabled', false).html('<i class="fas fa-play"></i> Bắt đầu');
                 stopButton.prop('disabled', true);
                 refreshStreamBtn.prop('disabled', true);
                 videoContainer.removeClass('is-streaming'); // Xóa class streaming
            }
        });

        // --- Get New Frame Button Click ---
        getNewFrameButton.click(function(){
            if(currentCameraIdForRoi){
                fetchAndDisplayRoiFrame(currentCameraIdForRoi);
            }
        });

        // --- Function to reload Attendance Log via AJAX --- 
        function reloadAttendanceLog(filterData) {
            console.log("[Log] Reloading log with filters:", filterData);
            logTableContainer.html('<div class="text-center p-3"><i class="fas fa-spinner fa-spin"></i> Đang tải...</div>'); // Show loading

            $.ajax({
                url: "{% url 'process-video-roi' %}", // Gửi đến view chính
                type: "GET",
                data: filterData, // Dữ liệu filter (search, start_date, end_date)
                dataType: "html", // Mong đợi nhận về HTML
                success: function(responseHtml) {
                    // Log phản hồi nhận được để debug
                    console.log("[Log] AJAX Success. Received HTML:", responseHtml.substring(0, 200) + "..."); 
                    
                    // --- Đơn giản hóa: Trực tiếp chèn HTML nhận được --- 
                    // Vì view đảm bảo chỉ trả về nội dung partial cho AJAX
                    logTableContainer.html(responseHtml);
                    console.log("[Log] Log reloaded successfully by direct insertion.");
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    // Log chi tiết lỗi
                    console.error("[Log] AJAX Error:", textStatus, jqXHR.status, errorThrown, jqXHR.responseText);
                    logTableContainer.html(`<div class="alert alert-danger m-2">Lỗi khi tải dữ liệu log: ${textStatus} (${jqXHR.status})</div>`);
                }
            });
        }

        // --- Log Filter Form Submission --- 
        logFilterForm.submit(function(e) {
            e.preventDefault(); // Ngăn form submit theo cách truyền thống
            var formData = $(this).serialize(); // Lấy dữ liệu form (search, start_date, end_date)
            reloadAttendanceLog(formData);
        });

        // --- Reload Log Button Click --- 
        reloadLogButton.click(function() {
            var formData = logFilterForm.serialize(); // Lấy filter hiện tại
            reloadAttendanceLog(formData);
        });

        // --- Refresh Stream Button Click ---
        refreshStreamBtn.click(function() {
            if ($("body").data("is-processing")) { // Chỉ refresh nếu đang xử lý
                console.log("[Stream] Refresh button clicked. is-processing: true");
                var currentSrc = videoStreamImg.attr('src');
                // Chỉ cập nhật nếu src hiện tại là video feed (tránh lỗi khi đang là placeholder)
                if (currentSrc.includes(videoFeedUrl)) { 
                    console.log("[Stream] Current src is video feed. Reloading...");
                    videoStreamImg.attr("src", videoFeedUrl + "?ts=" + new Date().getTime());
                } else {
                    console.warn("[Stream] Cannot refresh, current src is not the video feed:", currentSrc);
                }
            } else {
                console.log("[Stream] Refresh button clicked. is-processing: false. Not refreshing.");
            }
        });

        // --- Dataset Viewer Logic ---
        viewDatasetBtn.click(function(){
            console.log("[Dataset Viewer] Button clicked");
            usernameSelect.html('<option value="">Đang tải...</option>').prop('disabled', true); // Reset select
            imageContainer.html('').append(datasetPlaceholder.show()); // Reset image container
            datasetModal.modal('show');

            // Fetch usernames from backend
            $.ajax({
                url: "{% url 'get-dataset-usernames' %}", // URL mới cần tạo
                type: "GET",
                dataType: "json",
                success: function(response){
                    console.log("[Dataset Viewer] Usernames received:", response);
                    usernameSelect.html('<option value="">-- Chọn Username --</option>'); // Reset với placeholder
                    if(response.usernames && response.usernames.length > 0){
                        response.usernames.forEach(function(username){
                            usernameSelect.append($('<option>', { 
                                value: username,
                                text : username 
                            }));
                        });
                        usernameSelect.prop('disabled', false);
                    } else {
                         usernameSelect.html('<option value="">Không tìm thấy dataset nào</option>');
                    }
                },
                error: function(jqXHR, textStatus, errorThrown){
                    console.error("[Dataset Viewer] Error fetching usernames:", textStatus, errorThrown);
                    usernameSelect.html('<option value="">Lỗi khi tải</option>');
                    alert("Lỗi khi tải danh sách username.");
                }
            });
        });

        // Handle username selection change
        usernameSelect.change(function(){
            var selectedUsername = $(this).val();
            imageContainer.html(''); // Clear previous images/placeholders
            datasetPlaceholder.hide();
            if(selectedUsername){
                console.log("[Dataset Viewer] Username selected:", selectedUsername);
                datasetLoading.show(); // Show loading spinner

                // Fetch random images for the selected username
                $.ajax({
                    url: `/get_random_images/${selectedUsername}/`, // URL mới cần tạo (sử dụng template literal cho username)
                    type: "GET",
                    dataType: "json",
                    success: function(response){
                        datasetLoading.hide();
                        console.log("[Dataset Viewer] Images received:", response);
                        if(response.images && response.images.length > 0){
                            response.images.forEach(function(base64Image){
                                // Append image with base64 source
                                var imgTag = '<img src="data:image/jpeg;base64,' + base64Image + '" class="img-thumbnail m-1" style="max-width: 150px; max-height: 150px;" alt="Dataset Image">';
                                imageContainer.append(imgTag);
                            });
                        } else {
                            imageContainer.html('<p class="text-muted">Không tìm thấy ảnh hoặc thư mục trống.</p>');
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown){
                        datasetLoading.hide();
                        console.error("[Dataset Viewer] Error fetching images:", textStatus, errorThrown);
                        imageContainer.html('<p class="text-danger">Lỗi khi tải ảnh.</p>');
                        alert("Lỗi khi tải ảnh cho username: " + selectedUsername);
                    }
                });
            } else {
                 imageContainer.append(datasetPlaceholder.show()); // Show placeholder if no username selected
            }
        });

    });
</script>

</body>
</html> 