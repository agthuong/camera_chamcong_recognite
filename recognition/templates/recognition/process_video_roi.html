{% load static %}
{% load crispy_forms_tags %}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Xử lý Video ROI</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        body {
            padding-top: 2rem;
            padding-bottom: 2rem;
            background-color: #f8f9fa; /* Light gray background */
        }
        .card {
            margin-top: 2rem;
        }
        .roi-status {
            margin-bottom: 1rem;
            padding: 0.75rem 1.25rem;
            border: 1px solid transparent;
            border-radius: 0.25rem;
        }
        .roi-status-selected {
            color: #0f5132;
            background-color: #d1e7dd;
            border-color: #badbcc;
        }
        .roi-status-not-selected {
            color: #664d03;
            background-color: #fff3cd;
            border-color: #ffecb5;
        }
        .camera-section .form-group {
            display: flex;
            align-items: flex-start; /* Align items to the top */
            gap: 10px; /* Add some space between elements */
        }
        /* Allow crispy form group for camera to take up space */
        .camera-section .form-group > div {
             flex-grow: 1;
        }
        /* Adjust button size/margin if needed */
        .camera-section .btn-sm {
             margin-top: 5px; /* Add margin if needed */
        }
        .table-responsive {
            margin-top: 2rem;
        }
        .img-thumbnail {
            max-width: 100px;
            max-height: 100px;
        }
        .video-container {
            position: relative;
            width: 100%;
            background-color: #222; /* Darker background */
            margin-bottom: 1rem;
            min-height: 300px; /* Ensure minimum height */
            display: flex; /* Use flexbox for centering */
            align-items: center;
            justify-content: center;
            overflow: hidden; /* Hide overflow */
        }
        .video-container img {
            width: 100%;
            height: auto;
            display: block;
            max-width: 100%; /* Ensure image doesn't exceed container */
            max-height: 600px; /* Limit max height if needed */
        }
        .video-placeholder-text {
            position: absolute; /* Overlay text */
            color: #aaa;
            text-align: center;
            font-size: 1.2rem;
        }
        /* Hide placeholder text when the image source is the video feed */
        .video-container img[src*="video-feed"] + .video-placeholder-text {
            display: none;
        }
        /* Hide placeholder image when video feed is active (can use JS too) */
        /* Optional: Add class via JS when processing starts */
        .is-streaming .video-placeholder-text {
             display: none;
        }

        /* Ensure username field group is initially hidden if not collect */
        #username-field-group:not(.mode-collect) {
            display: none;
        }

        .control-buttons button {
            margin-right: 5px;
        }
        /* Style cho div username khi được di chuyển (tùy chọn) */
        #div_id_username.moved-username-field {
            margin-left: 25px; 
            margin-top: 5px; /* Tăng khoảng cách trên */
            margin-bottom: 15px; 
            border-left: 2px solid #eee; 
            padding-left: 15px;
            padding-top: 5px; /* Thêm padding trên nếu cần */
        }
    </style>
</head>
<body data-is-processing="{% if is_processing %}true{% else %}false{% endif %}">

<div class="container-fluid mt-4"> <!-- Sử dụng container-fluid để rộng hơn -->
    <div class="row">
        <!-- Cột Video Stream và Controls (rộng hơn) -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm">
                 <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Video Stream</h4>
                     <!-- Nút Stop được đặt ở header -->
                     <form method="POST" style="display: inline;">
                         {% csrf_token %}
                         <input type="hidden" name="action" value="stop">
                         <button type="submit" class="btn btn-danger btn-sm" {% if not is_processing %}disabled{% endif %}>
                             <i class="fas fa-stop"></i> Dừng Xử lý
                         </button>
                     </form>
                </div>
                <div class="card-body">
                    <div class="video-container {% if is_processing %}is-streaming{% endif %}"> <!-- Add class if streaming -->
                         <!-- Image tag for video stream or placeholder -->
                        <img id="video-stream" 
                             src="{% if is_processing %}{% url 'video-feed' %}{% else %}{% static 'recognition/img/placeholder.png' %}{% endif %}" 
                             alt="Video Stream Area">
                        <!-- Placeholder text overlay -->
                        <div class="video-placeholder-text">
                             {% if not is_processing %}
                             Vui lòng chọn camera và bắt đầu xử lý.
                             {% endif %}
                         </div>
                     </div>
                </div>
             </div>
        </div>

        <!-- Cột Cấu hình và Log/Bảng Chấm công (hẹp hơn) -->
        <div class="col-lg-4">
            <!-- Card Cấu hình -->
            <div class="card shadow-sm mb-4">
                 <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Cấu hình & Bắt đầu</h4>
                </div>
                <div class="card-body">
                     {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <form method="POST" id="process-form" novalidate>
                         {% csrf_token %}
                        <input type="hidden" name="action" value="start"> <!-- Action mặc định là start -->

                        <!-- Phần chọn Camera và nút Add -->
                         <div class="camera-section mb-3">
                             <div class="form-group mb-0">
                                {{ form.camera|as_crispy_field }}
                                <a href="{% url 'add-camera' %}" class="btn btn-success btn-sm mt-4" title="Thêm Camera Mới">
                                    <i class="fas fa-plus"></i>
                                </a>
                            </div>
                            <small class="form-text text-muted mt-0 mb-2">
                                ROI sẽ được lấy tự động. <a href="#" id="configure-roi-link">Cấu hình ROI?</a>
                            </small>
                        </div>

                        <!-- Chế độ xử lý -->
                         <div class="form-group">
                            {{ form.mode|as_crispy_field }}
                        </div>
                         <!-- Username field group - Sẽ được di chuyển bằng JS -->
                         <div class="form-group {% if form.mode.value != 'collect' %}d-none{% endif %}" id="div_id_username">
                             {{ form.username|as_crispy_field }}
                        </div>

                        <!-- Nút Bắt đầu -->
                        <div class="form-group mt-3 text-center control-buttons">
                            <button class="btn btn-primary" type="submit" {% if is_processing %}disabled{% endif %}>
                                 <i class="fas fa-play"></i> Bắt đầu Xử lý
                             </button>
                         </div>
                     </form>
                     <hr>
                     <div class="text-center">
                         <a href="{% url 'train' %}" id="train-button" class="btn btn-info btn-sm">Huấn luyện Model</a>
                     </div>
                 </div>
             </div>

            <!-- Card Bảng Chấm Công -->
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">Chấm công gần đây</h4>
                </div>
                <div class="card-body">
                    <!-- Form tìm kiếm (có thể giữ hoặc bỏ) -->
                     <form method="get" class="mb-3">
                         <div class="input-group input-group-sm">
                             <input type="text" class="form-control" name="search" placeholder="Tìm tên..." value="{{ search_query }}">
                             <div class="input-group-append">
                                 <button type="submit" class="btn btn-secondary">Tìm</button>
                             </div>
                         </div>
                    </form>
                    <!-- Bảng chấm công -->
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;"> <!-- Giới hạn chiều cao và scroll -->
                        <table class="table table-sm table-striped table-hover">
                             <thead class="thead-light sticky-top"> <!-- Header cố định khi scroll -->
                                <tr>
                                    <th>Ngày</th>
                                    <th>Người dùng</th>
                                    <th>In</th>
                                    <th>Out</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in records %}
                                <tr>
                                     <td>{{ record.date|date:"d/m" }}</td>
                                    <td>{{ record.user.get_full_name|default:record.user.username|truncatechars:15 }}</td>
                                    <td>{{ record.check_in|date:"H:i"|default:"-" }}</td>
                                    <td>{{ record.check_out|date:"H:i"|default:"-" }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted">Chưa có dữ liệu</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                 </div>
             </div>
        </div>
    </div>
</div>

<!-- Optional JavaScript -->
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

<script>
    $(document).ready(function() {
        var cameraSelect = $('#id_camera');
        var modeSelect = $('#id_mode');
        var usernameFieldGroup = $('#div_id_username');
        var processForm = $("#process-form");
        var startButton = processForm.find("button[type='submit']");
        var stopButton = $("form button:contains('Dừng Xử lý')");
        var videoStreamImg = $("#video-stream");
        var videoContainer = $(".video-container");
        var placeholderText = $(".video-placeholder-text");
        var placeholderSrc = "{% static 'recognition/img/placeholder.png' %}";
        var videoFeedUrl = "{% url 'video-feed' %}";
        var collectRadioButtonLabel; // Biến để lưu label của radio 'collect'

        // --- Move Username Field --- 
        // Tìm input radio có giá trị 'collect' và label tương ứng của nó
        try {
             collectRadioButtonLabel = $('input[name="mode"][value="collect"]').closest('.form-check').find('label');
             if (collectRadioButtonLabel.length > 0 && usernameFieldGroup.length > 0) {
                 // Di chuyển div username ngay sau label của radio 'collect'
                 usernameFieldGroup.insertAfter(collectRadioButtonLabel).addClass('moved-username-field'); 
                 console.log("Moved username field after 'collect' radio label.");
             } else {
                 console.warn("Could not find 'collect' radio label or username field group to move.");
             }
        } catch (e) {
             console.error("Error moving username field:", e);
        }

        // --- Function to toggle Username field --- 
        function toggleUsernameField() {
            // Lấy giá trị mode được chọn trực tiếp từ radio buttons
            var selectedMode = $('input[name="mode"]:checked').val();
            console.log("Mode changed to:", selectedMode);
            if (selectedMode === 'collect') {
                console.log("Showing username field");
                usernameFieldGroup.removeClass('d-none');
            } else {
                console.log("Hiding username field");
                usernameFieldGroup.addClass('d-none');
            }
        }
        toggleUsernameField(); // Initial check
        // Gắn sự kiện change vào TẤT CẢ radio buttons trong group 'mode'
        $('input[name="mode"]').change(toggleUsernameField); 

        $('.alert .close').on('click', function(e) {
            $(this).parent().alert('close');
        });

        $("#train-button").click(function(e){
            if (!confirm("Bắt đầu huấn luyện? Việc này có thể mất vài phút.")) {
                e.preventDefault();
            }
        });

        $("#configure-roi-link").click(function(e){
            e.preventDefault();
            var selectedCameraId = cameraSelect.val();
            if (!selectedCameraId) {
                alert("Vui lòng chọn camera trước."); return;
            }
            var selectUrl = `/select_roi/${selectedCameraId}/`;
            alert("Mở cửa sổ chọn ROI. Kiểm tra cửa sổ OpenCV...");
            window.location.href = selectUrl;
        });

        processForm.submit(function(e) {
            if (!cameraSelect.val()) {
                alert("Vui lòng chọn camera."); e.preventDefault(); return false;
            }
            if (modeSelect.val() === 'collect' && !$("#id_username").val()) {
                 alert("Vui lòng nhập Username cho chế độ Thu thập."); e.preventDefault(); return false;
            }
            
            startButton.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Bắt đầu...');
            stopButton.prop('disabled', false);
            placeholderText.hide();
            videoContainer.addClass('is-streaming');
            videoStreamImg.attr("src", videoFeedUrl + "?ts=" + new Date().getTime());
            
            return true;
        });

        if ($("body").data("is-processing")) {
             startButton.prop('disabled', true);
             stopButton.prop('disabled', false);
             placeholderText.hide();
             videoContainer.addClass('is-streaming');
             if (videoStreamImg.attr('src') !== videoFeedUrl) {
                 videoStreamImg.attr('src', videoFeedUrl + "?ts=" + new Date().getTime());
             }
        } else {
             startButton.prop('disabled', false).html('<i class="fas fa-play"></i> Bắt đầu Xử lý');
             stopButton.prop('disabled', true);
             placeholderText.show();
             videoContainer.removeClass('is-streaming');
              if (videoStreamImg.attr('src') !== placeholderSrc) {
                 videoStreamImg.attr('src', placeholderSrc);
             }
        }

        videoStreamImg.on('error', function() {
            if (videoContainer.hasClass('is-streaming')) {
                console.error("Video stream error or stopped.");
                $(this).attr('src', placeholderSrc);
                placeholderText.text("Lỗi kết nối stream hoặc đã dừng.").show();
                 startButton.prop('disabled', false).html('<i class="fas fa-play"></i> Bắt đầu Xử lý');
                 stopButton.prop('disabled', true);
                 videoContainer.removeClass('is-streaming');
            }
        });

    });
</script>

</body>
</html> 